{
  "version": 3,
  "sources": ["../../../../Desktop/civic-complaints-backup/netlify/functions/submitReport.js"],
  "sourceRoot": "C:/Users/PC/AppData/Local/Temp/tmp-8184-8Obhh8i8s5M5",
  "sourcesContent": ["// netlify/functions/submitReport.js\r\nexport const config = { path: \"/.netlify/functions/submitReport\" };\r\n\r\nfunction cors(res) {\r\n  return {\r\n    ...res,\r\n    headers: {\r\n      \"Access-Control-Allow-Origin\": \"*\",\r\n      \"Access-Control-Allow-Headers\": \"Content-Type, Authorization\",\r\n      \"Access-Control-Allow-Methods\": \"POST,OPTIONS\",\r\n      \"Content-Type\": \"application/json\",\r\n    },\r\n  };\r\n}\r\n\r\nexport async function handler(event) {\r\n  if (event.httpMethod === \"OPTIONS\") return cors({ statusCode: 200, body: \"\" });\r\n  if (event.httpMethod !== \"POST\")    return cors({ statusCode: 405, body: JSON.stringify({ error: \"Method Not Allowed\" }) });\r\n\r\n  const { REPO_OWNER, REPO_NAME, GITHUB_TOKEN } = process.env;\r\n  if (!REPO_OWNER || !REPO_NAME || !GITHUB_TOKEN) {\r\n    return cors({ statusCode: 500, body: JSON.stringify({ error: \"Missing server env\" }) });\r\n  }\r\n\r\n  try {\r\n    const p0 = JSON.parse(event.body || \"{}\");\r\n\r\n    // \u062A\u0646\u0638\u064A\u0641 \u0627\u0644\u062D\u0642\u0648\u0644\r\n    const p = {\r\n      fullName: (p0.fullName || \"\").trim(),\r\n      eventDateTime: (p0.eventDateTime || \"\").trim(),\r\n      place: (p0.place || \"\").trim(),\r\n      category: (p0.category || \"\").trim(),\r\n      body: (p0.body || \"\").trim(),\r\n      evidenceUrl: (p0.evidenceUrl || \"\").trim(),\r\n    };\r\n\r\n    // \u0627\u0644\u062A\u062D\u0642\u0642 \u0645\u0646 \u0627\u0644\u0645\u062F\u062E\u0644\u0627\u062A\r\n    const errs = [];\r\n    if (!p.eventDateTime) errs.push(\"\u062A\u0627\u0631\u064A\u062E/\u0648\u0642\u062A \u0627\u0644\u0648\u0627\u0642\u0639\u0629 \u0645\u0637\u0644\u0648\u0628.\");\r\n    if (!p.place)         errs.push(\"\u0627\u0644\u0645\u0643\u0627\u0646 \u0645\u0637\u0644\u0648\u0628.\");\r\n    if (!p.category)      errs.push(\"\u0627\u0644\u062A\u0635\u0646\u064A\u0641 \u0645\u0637\u0644\u0648\u0628.\");\r\n    if (!p.body || p.body.length < 120) errs.push(\"\u0646\u0635 \u0627\u0644\u062A\u0642\u0631\u064A\u0631 \u0642\u0635\u064A\u0631 (\u2265 120 \u062D\u0631\u0641\u064B\u0627).\");\r\n    if (errs.length) return cors({ statusCode: 422, body: JSON.stringify({ error: errs.join(\" \") }) });\r\n\r\n    // \u062F\u0639\u0645 \u0639\u062F\u0629 \u0631\u0648\u0627\u0628\u0637 \u0623\u062F\u0644\u0629 \u0645\u0641\u0635\u0648\u0644\u0629 \u0628\u0641\u0648\u0627\u0635\u0644\r\n    let evidenceBlock = \"\";\r\n    if (p.evidenceUrl) {\r\n      const links = p.evidenceUrl.split(\",\").map(s => s.trim()).filter(Boolean);\r\n      if (links.length === 1) {\r\n        evidenceBlock = `**\u0631\u0648\u0627\u0628\u0637 \u0623\u062F\u0644\u0629:** ${links[0]}`;\r\n      } else if (links.length > 1) {\r\n        evidenceBlock = `**\u0631\u0648\u0627\u0628\u0637 \u0623\u062F\u0644\u0629:**\\n${links.map(u => `- ${u}`).join(\"\\n\")}`;\r\n      }\r\n    }\r\n\r\n    const title = `\u062A\u0642\u0631\u064A\u0631: [${p.category}] \u2014 ${p.place} \u2014 ${p.eventDateTime}`;\r\n    const md = [\r\n      `**\u0627\u0644\u0646\u0648\u0639:** \u062A\u0642\u0631\u064A\u0631`,\r\n      p.fullName ? `**\u0645\u0628\u0644\u0651\u0650\u063A:** ${p.fullName}` : \"\",\r\n      `**\u062A\u0627\u0631\u064A\u062E/\u0648\u0642\u062A \u0627\u0644\u0648\u0627\u0642\u0639\u0629:** ${p.eventDateTime}`,\r\n      `**\u0627\u0644\u0645\u0643\u0627\u0646:** ${p.place}`,\r\n      \"\",\r\n      p.body,\r\n      \"\",\r\n      evidenceBlock,\r\n    ].filter(Boolean).join(\"\\n\");\r\n\r\n    const labels = [\"pending\", \"type: report\", `topic: ${p.category}`];\r\n    if (p.place) labels.push(`city: ${p.place}`);\r\n\r\n    const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues`, {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Authorization\": `Bearer ${GITHUB_TOKEN}`,\r\n        \"Accept\": \"application/vnd.github+json\",\r\n        \"Content-Type\": \"application/json\",\r\n      },\r\n      body: JSON.stringify({ title, body: md, labels }),\r\n    });\r\n\r\n    if (!res.ok) {\r\n      const t = await res.text();\r\n      return cors({ statusCode: 500, body: JSON.stringify({ error: `GitHub error: ${t}` }) });\r\n    }\r\n\r\n    const issue = await res.json();\r\n    return cors({\r\n      statusCode: 200,\r\n      body: JSON.stringify({ number: issue.number, html_url: issue.html_url }),\r\n    });\r\n\r\n  } catch (e) {\r\n    return cors({ statusCode: 500, body: JSON.stringify({ error: String(e.message || e) }) });\r\n  }\r\n}\r\n"],
  "mappings": "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",
  "names": []
}
