{
  "version": 3,
  "sources": ["../../../../Desktop/civic-complaints-backup/netlify/functions/adminSetStatus.js"],
  "sourceRoot": "C:/Users/PC/AppData/Local/Temp/tmp-8184-MZiCOmvcOm4T",
  "sourcesContent": ["// netlify/functions/adminSetStatus.js\r\nimport bcrypt from \"bcryptjs\";\r\n\r\nexport const config = { path: \"/.netlify/functions/adminSetStatus\" };\r\n\r\nfunction cors(res) {\r\n  return {\r\n    ...res,\r\n    headers: {\r\n      \"Access-Control-Allow-Origin\": \"*\",\r\n      \"Access-Control-Allow-Headers\": \"Content-Type, Authorization\",\r\n      \"Access-Control-Allow-Methods\": \"POST,OPTIONS\",\r\n      \"Content-Type\": \"application/json\",\r\n    },\r\n  };\r\n}\r\n\r\nconst STATE_LABELS = new Set([\"pending\", \"approved\", \"rejected\", \"under-review\", \"needs-more-info\"]);\r\n\r\nexport async function handler(event) {\r\n  if (event.httpMethod === \"OPTIONS\") return cors({ statusCode: 200, body: \"\" });\r\n  if (event.httpMethod !== \"POST\") {\r\n    return cors({ statusCode: 405, body: JSON.stringify({ error: \"Method Not Allowed\" }) });\r\n  }\r\n\r\n  const { REPO_OWNER, REPO_NAME, GITHUB_TOKEN, ADMIN_HASH } = process.env;\r\n  if (!REPO_OWNER || !REPO_NAME || !GITHUB_TOKEN || !ADMIN_HASH) {\r\n    return cors({ statusCode: 500, body: JSON.stringify({ error: \"Server env missing\" }) });\r\n  }\r\n\r\n  try {\r\n    const { number, state, password } = JSON.parse(event.body || \"{}\");\r\n\r\n    // \u062A\u062D\u0642\u0642 \u0623\u0648\u0644\u064A \u0645\u0646 \u0627\u0644\u062D\u0645\u0648\u0644\u0629\r\n    if (!number || !state || !password) {\r\n      return cors({ statusCode: 422, body: JSON.stringify({ error: \"invalid payload\" }) });\r\n    }\r\n    if (!STATE_LABELS.has(String(state))) {\r\n      return cors({ statusCode: 422, body: JSON.stringify({ error: \"invalid state\" }) });\r\n    }\r\n\r\n    // \u062A\u062D\u0642\u0642 \u0643\u0644\u0645\u0629 \u0627\u0644\u0633\u0631 (Bcrypt)\r\n    const ok = await bcrypt.compare(String(password), String(ADMIN_HASH));\r\n    if (!ok) {\r\n      return cors({ statusCode: 401, body: JSON.stringify({ error: \"\u0643\u0644\u0645\u0629 \u0627\u0644\u0633\u0631 \u063A\u064A\u0631 \u0635\u062D\u064A\u062D\u0629\" }) });\r\n    }\r\n\r\n    // \u062C\u0644\u0628 \u0627\u0644\u0640 Issue \u0627\u0644\u062D\u0627\u0644\u064A\r\n    const issueUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${number}`;\r\n    const getRes = await fetch(issueUrl, {\r\n      headers: {\r\n        \"Authorization\": `Bearer ${GITHUB_TOKEN}`,\r\n        \"Accept\": \"application/vnd.github+json\",\r\n      },\r\n    });\r\n    if (!getRes.ok) {\r\n      const t = await getRes.text();\r\n      return cors({ statusCode: 404, body: JSON.stringify({ error: `issue not found: ${t}` }) });\r\n    }\r\n    const issue = await getRes.json();\r\n    const current = (issue.labels || []).map((l) => l.name);\r\n\r\n    // \u0625\u0632\u0627\u0644\u0629 \u0648\u0633\u0648\u0645 \u0627\u0644\u062D\u0627\u0644\u0629 \u0627\u0644\u0642\u062F\u064A\u0645\u0629 \u062B\u0645 \u0625\u0636\u0627\u0641\u0629 \u0627\u0644\u062D\u0627\u0644\u0629 \u0627\u0644\u062C\u062F\u064A\u062F\u0629 \u0648\u0627\u0644\u062D\u0641\u0627\u0638 \u0639\u0644\u0649 \u0628\u0642\u064A\u0629 \u0627\u0644\u0648\u0633\u0648\u0645\r\n    const kept = current.filter((l) => !STATE_LABELS.has(l));\r\n    const labels = Array.from(new Set([...kept, state]));\r\n\r\n    // \u062A\u062D\u062F\u064A\u062B \u0627\u0644\u0648\u0633\u0648\u0645\r\n    const patchRes = await fetch(issueUrl, {\r\n      method: \"PATCH\",\r\n      headers: {\r\n        \"Authorization\": `Bearer ${GITHUB_TOKEN}`,\r\n        \"Accept\": \"application/vnd.github+json\",\r\n        \"Content-Type\": \"application/json\",\r\n      },\r\n      body: JSON.stringify({ labels }),\r\n    });\r\n\r\n    if (!patchRes.ok) {\r\n      const t = await patchRes.text();\r\n      return cors({ statusCode: 500, body: JSON.stringify({ error: `update failed: ${t}` }) });\r\n    }\r\n\r\n    return cors({ statusCode: 200, body: JSON.stringify({ ok: true }) });\r\n  } catch (e) {\r\n    return cors({ statusCode: 500, body: JSON.stringify({ error: e.message || String(e) }) });\r\n  }\r\n}\r\n"],
  "mappings": "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",
  "names": ["bcrypt"]
}
