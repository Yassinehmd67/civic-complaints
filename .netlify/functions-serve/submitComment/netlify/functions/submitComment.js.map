{
  "version": 3,
  "sources": ["../../../../Desktop/civic-complaints-backup/netlify/functions/submitComment.js"],
  "sourceRoot": "C:/Users/PC/AppData/Local/Temp/tmp-8184-ss8v2oyxTmeV",
  "sourcesContent": ["// netlify/functions/submitComment.js\r\nexport const config = { path: \"/.netlify/functions/submitComment\" };\r\n\r\n/* ---------- Helpers ---------- */\r\nfunction cors(res) {\r\n  return {\r\n    ...res,\r\n    headers: {\r\n      \"Access-Control-Allow-Origin\": \"*\",\r\n      \"Access-Control-Allow-Headers\": \"Content-Type, Authorization\",\r\n      \"Access-Control-Allow-Methods\": \"POST,OPTIONS\",\r\n      \"Content-Type\": \"application/json\",\r\n    },\r\n  };\r\n}\r\nconst toJSON = (o) => JSON.stringify(o);\r\n\r\n/** \u062A\u0646\u0638\u064A\u0641 \u0627\u0644\u0645\u0633\u0627\u0641\u0627\u062A \u0627\u0644\u0639\u0631\u0628\u064A\u0629/\u0627\u0644\u0644\u0627\u062A\u064A\u0646\u064A\u0629 */\r\nfunction clean(s = \"\") {\r\n  return String(s).replace(/\\s+/g, \" \").trim();\r\n}\r\n\r\n/* ---------- Handler ---------- */\r\nexport async function handler(event) {\r\n  // CORS preflight\r\n  if (event.httpMethod === \"OPTIONS\") return cors({ statusCode: 200, body: \"\" });\r\n  if (event.httpMethod !== \"POST\") {\r\n    return cors({ statusCode: 405, body: toJSON({ ok: false, error: \"Method Not Allowed\" }) });\r\n  }\r\n\r\n  const { SUPABASE_URL, SUPABASE_SERVICE_ROLE } = process.env;\r\n  if (!SUPABASE_URL || !SUPABASE_SERVICE_ROLE) {\r\n    return cors({ statusCode: 500, body: toJSON({ ok: false, error: \"Missing Supabase env vars\" }) });\r\n  }\r\n\r\n  try {\r\n    const payload = JSON.parse(event.body || \"{}\");\r\n    let { issueNumber, fullName, comment } = payload;\r\n\r\n    // Normalize\r\n    issueNumber = Number(issueNumber);\r\n    fullName = clean(fullName);\r\n    comment = clean(comment);\r\n\r\n    // Validation\r\n    const errs = [];\r\n    if (!Number.isFinite(issueNumber) || issueNumber <= 0) errs.push(\"\u0631\u0642\u0645 \u0627\u0644\u0645\u0644\u0641 \u063A\u064A\u0631 \u0635\u0627\u0644\u062D.\");\r\n    if (!fullName || fullName.length < 8 || fullName.length > 80) errs.push(\"\u0627\u0644\u0627\u0633\u0645 \u0627\u0644\u0643\u0627\u0645\u0644 \u0645\u0637\u0644\u0648\u0628 (8\u201380 \u062D\u0631\u0641\u064B\u0627).\");\r\n    if (!comment || comment.length < 40) errs.push(\"\u0627\u0644\u062A\u0639\u0644\u064A\u0642 \u0642\u0635\u064A\u0631 \u062C\u062F\u064B\u0627. \u0627\u0644\u062D\u062F \u0627\u0644\u0623\u062F\u0646\u0649 40 \u062D\u0631\u0641\u064B\u0627.\");\r\n    if (comment.length > 2000) errs.push(\"\u0627\u0644\u062A\u0639\u0644\u064A\u0642 \u0637\u0648\u064A\u0644 \u062C\u062F\u064B\u0627. \u0627\u0644\u062D\u062F \u0627\u0644\u0623\u0642\u0635\u0649 2000 \u062D\u0631\u0641.\");\r\n\r\n    if (errs.length) {\r\n      return cors({ statusCode: 422, body: toJSON({ ok: false, error: errs.join(\" \") }) });\r\n    }\r\n\r\n    // Insert into Supabase (pending review)\r\n    const insertRow = {\r\n      issue_number: issueNumber,\r\n      full_name: fullName,\r\n      comment: comment,\r\n    };\r\n\r\n    const url = `${SUPABASE_URL}/rest/v1/pending_comments`;\r\n    const res = await fetch(url, {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"apikey\": SUPABASE_SERVICE_ROLE,\r\n        \"Authorization\": `Bearer ${SUPABASE_SERVICE_ROLE}`,\r\n        \"Content-Type\": \"application/json\",\r\n        \"Prefer\": \"return=representation\"\r\n      },\r\n      body: JSON.stringify(insertRow),\r\n    });\r\n\r\n    if (!res.ok) {\r\n      const text = await res.text();\r\n      return cors({\r\n        statusCode: 500,\r\n        body: toJSON({ ok: false, error: `Supabase error: ${text || res.status}` }),\r\n      });\r\n    }\r\n\r\n    const rows = await res.json(); // representation with the new row\r\n    const row = Array.isArray(rows) ? rows[0] : rows;\r\n\r\n    return cors({\r\n      statusCode: 200,\r\n      body: toJSON({\r\n        ok: true,\r\n        id: row?.id || null,\r\n        message: \"\u062A\u0645 \u0627\u0633\u062A\u0644\u0627\u0645 \u0627\u0644\u062A\u0639\u0644\u064A\u0642 \u0648\u064A\u062D\u062A\u0627\u062C \u0644\u0645\u0631\u0627\u062C\u0639\u0629 \u0627\u0644\u0645\u062F\u064A\u0631 \u0642\u0628\u0644 \u0627\u0644\u0646\u0634\u0631.\"\r\n      }),\r\n    });\r\n  } catch (e) {\r\n    return cors({\r\n      statusCode: 500,\r\n      body: toJSON({ ok: false, error: e?.message || String(e) }),\r\n    });\r\n  }\r\n}\r\n"],
  "mappings": "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",
  "names": []
}
