{
  "version": 3,
  "sources": ["../../../../Desktop/civic-complaints-backup/netlify/functions/moderateComment.js"],
  "sourceRoot": "C:/Users/PC/AppData/Local/Temp/tmp-8184-SGTJCjQnwmR8",
  "sourcesContent": ["// netlify/functions/moderateComment.js\r\nexport const config = { path: \"/.netlify/functions/moderateComment\" };\r\n\r\nimport bcrypt from \"bcryptjs\";\r\n\r\nfunction cors(res) {\r\n  return {\r\n    ...res,\r\n    headers: {\r\n      \"Access-Control-Allow-Origin\": \"*\",\r\n      \"Access-Control-Allow-Headers\": \"Content-Type, Authorization\",\r\n      \"Access-Control-Allow-Methods\": \"POST,OPTIONS\",\r\n      \"Content-Type\": \"application/json\",\r\n    },\r\n  };\r\n}\r\nconst toJSON = (o) => JSON.stringify(o);\r\n\r\nexport async function handler(event) {\r\n  if (event.httpMethod === \"OPTIONS\") return cors({ statusCode: 200, body: \"\" });\r\n  if (event.httpMethod !== \"POST\") return cors({ statusCode: 405, body: toJSON({ ok:false, error:\"Method Not Allowed\" }) });\r\n\r\n  const {\r\n    SUPABASE_URL,\r\n    SUPABASE_SERVICE_ROLE,\r\n    REPO_OWNER,\r\n    REPO_NAME,\r\n    GITHUB_TOKEN,\r\n    ADMIN_HASH\r\n  } = process.env;\r\n\r\n  if (!SUPABASE_URL || !SUPABASE_SERVICE_ROLE) {\r\n    return cors({ statusCode: 500, body: toJSON({ ok:false, error:\"Missing Supabase env vars\" }) });\r\n  }\r\n  if (!REPO_OWNER || !REPO_NAME || !GITHUB_TOKEN) {\r\n    return cors({ statusCode: 500, body: toJSON({ ok:false, error:\"Missing GitHub env vars\" }) });\r\n  }\r\n  if (!ADMIN_HASH) {\r\n    return cors({ statusCode: 500, body: toJSON({ ok:false, error:\"Missing ADMIN_HASH\" }) });\r\n  }\r\n\r\n  try {\r\n    const { id, action, password } = JSON.parse(event.body || \"{}\");\r\n    if (!id || !action || !password) {\r\n      return cors({ statusCode: 422, body: toJSON({ ok:false, error:\"\u0628\u064A\u0627\u0646\u0627\u062A \u0646\u0627\u0642\u0635\u0629.\" }) });\r\n    }\r\n\r\n    // \u062A\u062D\u0642\u0642 \u0643\u0644\u0645\u0629 \u0627\u0644\u0633\u0631\r\n    const passOk = await bcrypt.compare(password, ADMIN_HASH);\r\n    if (!passOk) return cors({ statusCode: 401, body: toJSON({ ok:false, error:\"\u0643\u0644\u0645\u0629 \u0627\u0644\u0633\u0631 \u063A\u064A\u0631 \u0635\u062D\u064A\u062D\u0629.\" }) });\r\n\r\n    // \u0627\u062C\u0644\u0628 \u0627\u0644\u062A\u0639\u0644\u064A\u0642 \u0645\u0646 Supabase \u0644\u0645\u0646\u0639 \u0627\u0644\u062A\u0644\u0627\u0639\u0628\r\n    const getUrl = new URL(`${SUPABASE_URL}/rest/v1/pending_comments`);\r\n    getUrl.searchParams.set(\"id\", `eq.${id}`);\r\n    getUrl.searchParams.set(\"select\", \"id,issue_number,full_name,comment,created_at\");\r\n    const getRes = await fetch(getUrl, {\r\n      headers: {\r\n        \"apikey\": SUPABASE_SERVICE_ROLE,\r\n        \"Authorization\": `Bearer ${SUPABASE_SERVICE_ROLE}`,\r\n        \"Accept\": \"application/json\",\r\n      }\r\n    });\r\n    if (!getRes.ok) {\r\n      const t = await getRes.text();\r\n      return cors({ statusCode: 500, body: toJSON({ ok:false, error:`Supabase error: ${t || getRes.status}` }) });\r\n    }\r\n    const rows = await getRes.json();\r\n    const row = rows?.[0];\r\n    if (!row) return cors({ statusCode: 404, body: toJSON({ ok:false, error:\"\u0627\u0644\u062A\u0639\u0644\u064A\u0642 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F\" }) });\r\n\r\n    if (action === \"reject\") {\r\n      // \u0627\u062D\u0630\u0641 \u0641\u0642\u0637\r\n      const delUrl = new URL(`${SUPABASE_URL}/rest/v1/pending_comments`);\r\n      delUrl.searchParams.set(\"id\", `eq.${id}`);\r\n      const delRes = await fetch(delUrl, {\r\n        method: \"DELETE\",\r\n        headers: {\r\n          \"apikey\": SUPABASE_SERVICE_ROLE,\r\n          \"Authorization\": `Bearer ${SUPABASE_SERVICE_ROLE}`,\r\n        }\r\n      });\r\n      if (!delRes.ok) {\r\n        const t = await delRes.text();\r\n        return cors({ statusCode: 500, body: toJSON({ ok:false, error:`Supabase delete error: ${t || delRes.status}` }) });\r\n      }\r\n      return cors({ statusCode: 200, body: toJSON({ ok:true, action:\"rejected\" }) });\r\n    }\r\n\r\n    if (action === \"approve\") {\r\n      // \u0627\u0646\u0634\u0631 \u0641\u064A GitHub \u0643\u062A\u0639\u0644\u064A\u0642 \u0639\u0644\u0649 \u0627\u0644\u0640 Issue\r\n      const ghBody =\r\n        `**\u0627\u0644\u0627\u0633\u0645 \u0627\u0644\u0643\u0627\u0645\u0644:** ${row.full_name}\\n\\n` +\r\n        `${row.comment}\\n\\n` +\r\n        `_(\u0645\u0642\u0628\u0648\u0644 \u0645\u0646 \u0627\u0644\u0625\u062F\u0627\u0631\u0629)_`;\r\n\r\n      const ghUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${row.issue_number}/comments`;\r\n      const ghRes = await fetch(ghUrl, {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Authorization\": `Bearer ${GITHUB_TOKEN}`,\r\n          \"Accept\": \"application/vnd.github+json\",\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n        body: JSON.stringify({ body: ghBody }),\r\n      });\r\n      if (!ghRes.ok) {\r\n        const t = await ghRes.text();\r\n        return cors({ statusCode: 500, body: toJSON({ ok:false, error:`GitHub error: ${t || ghRes.status}` }) });\r\n      }\r\n      const ghData = await ghRes.json();\r\n\r\n      // \u0627\u062D\u0630\u0641 \u0645\u0646 pending_comments\r\n      const delUrl = new URL(`${SUPABASE_URL}/rest/v1/pending_comments`);\r\n      delUrl.searchParams.set(\"id\", `eq.${id}`);\r\n      const delRes = await fetch(delUrl, {\r\n        method: \"DELETE\",\r\n        headers: {\r\n          \"apikey\": SUPABASE_SERVICE_ROLE,\r\n          \"Authorization\": `Bearer ${SUPABASE_SERVICE_ROLE}`,\r\n        }\r\n      });\r\n      if (!delRes.ok) {\r\n        const t = await delRes.text();\r\n        return cors({ statusCode: 500, body: toJSON({ ok:false, error:`Supabase delete error: ${t || delRes.status}` }) });\r\n      }\r\n\r\n      return cors({ statusCode: 200, body: toJSON({ ok:true, action:\"approved\", github_comment_id: ghData?.id }) });\r\n    }\r\n\r\n    // \u063A\u064A\u0631 \u0645\u0639\u0631\u0648\u0641\u0629\r\n    return cors({ statusCode: 422, body: toJSON({ ok:false, error:\"\u0625\u062C\u0631\u0627\u0621 \u063A\u064A\u0631 \u0645\u0639\u0631\u0648\u0641\" }) });\r\n  } catch (e) {\r\n    return cors({ statusCode: 500, body: toJSON({ ok:false, error: e?.message || String(e) }) });\r\n  }\r\n}\r\n"],
  "mappings": "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",
  "names": ["bcrypt"]
}
