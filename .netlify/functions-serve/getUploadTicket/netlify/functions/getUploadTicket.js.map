{
  "version": 3,
  "sources": ["../../../../Desktop/civic-complaints-backup/netlify/functions/getUploadTicket.js"],
  "sourceRoot": "C:/Users/PC/AppData/Local/Temp/tmp-11528-wDLJPirLFugr",
  "sourcesContent": ["// netlify/functions/getUploadTicket.js\r\nimport { createClient } from \"@supabase/supabase-js\";\r\n\r\nexport const config = { path: \"/.netlify/functions/getUploadTicket\" };\r\n\r\nfunction cors(res) {\r\n  return {\r\n    ...res,\r\n    headers: {\r\n      \"Access-Control-Allow-Origin\": \"*\",\r\n      \"Access-Control-Allow-Headers\": \"Content-Type, Authorization\",\r\n      \"Access-Control-Allow-Methods\": \"POST, OPTIONS\",\r\n      \"Content-Type\": \"application/json\",\r\n    },\r\n  };\r\n}\r\n\r\nconst { SUPABASE_URL, SUPABASE_SERVICE_ROLE, SUPABASE_BUCKET } = process.env;\r\n\r\n// \u0627\u0644\u0623\u0646\u0648\u0627\u0639 \u0627\u0644\u0645\u0633\u0645\u0648\u062D \u0628\u0647\u0627 \u0648\u062D\u062C\u0645 10MB (\u0644\u0644\u0627\u062A\u0633\u0627\u0642 \u0645\u0639 \u0627\u0644\u062E\u0644\u0641\u064A\u0627\u062A \u0627\u0644\u0623\u062E\u0631\u0649)\r\nconst ALLOWED = new Set([\"application/pdf\", \"image/png\", \"image/jpeg\"]);\r\nconst MAX_BYTES = 10 * 1024 * 1024; // 10MB (\u0645\u0639\u0644\u0648\u0645\u0629 \u0641\u0642\u0637 \u0647\u0646\u0627)\r\n\r\nexport async function handler(event) {\r\n  try {\r\n    if (event.httpMethod === \"OPTIONS\") {\r\n      return cors({ statusCode: 200, body: \"\" });\r\n    }\r\n    if (event.httpMethod !== \"POST\") {\r\n      return cors({\r\n        statusCode: 405,\r\n        body: JSON.stringify({ error: \"Method Not Allowed\" }),\r\n      });\r\n    }\r\n\r\n    if (!SUPABASE_URL || !SUPABASE_SERVICE_ROLE || !SUPABASE_BUCKET) {\r\n      return cors({\r\n        statusCode: 500,\r\n        body: JSON.stringify({ error: \"Missing Supabase env vars\" }),\r\n      });\r\n    }\r\n\r\n    // \u0645\u062F\u062E\u0644\u0627\u062A \u0627\u062E\u062A\u064A\u0627\u0631\u064A\u0629 \u0645\u0646 \u0627\u0644\u0648\u0627\u062C\u0647\u0629: mime \u0648\u0627\u0633\u0645 \u0645\u0642\u062A\u0631\u062D (\u0644\u0627 \u0646\u0633\u062A\u062E\u062F\u0645 \u0627\u0644\u0627\u0633\u0645 \u0643\u0645\u0627 \u0647\u0648 \u062D\u0641\u0627\u0638\u0627\u064B \u0639\u0644\u0649 \u0627\u0644\u0623\u0645\u0627\u0646)\r\n    const { mime = \"application/pdf\" } = JSON.parse(event.body || \"{}\");\r\n\r\n    // \u062A\u062D\u0642\u0651\u0642 \u0627\u0644\u0646\u0648\u0639\r\n    if (!ALLOWED.has(mime)) {\r\n      return cors({\r\n        statusCode: 415,\r\n        body: JSON.stringify({\r\n          error: \"\u0646\u0648\u0639 \u0627\u0644\u0645\u0644\u0641 \u063A\u064A\u0631 \u0645\u0633\u0645\u0648\u062D. \u0627\u0644\u0645\u0633\u0645\u0648\u062D: PDF/PNG/JPG\",\r\n        }),\r\n      });\r\n    }\r\n\r\n    const ext =\r\n      mime === \"application/pdf\"\r\n        ? \"pdf\"\r\n        : mime === \"image/png\"\r\n        ? \"png\"\r\n        : \"jpg\";\r\n\r\n    // \u0645\u0633\u0627\u0631 \u0622\u0645\u0646 \u062F\u0627\u062E\u0644 \u0627\u0644\u0628\u0643\u062A\r\n    const objectPath = `proofs/${Date.now()}-${Math.random()\r\n      .toString(36)\r\n      .slice(2)}.${ext}`;\r\n\r\n    // \u0625\u0646\u0634\u0627\u0621 \u0639\u0645\u064A\u0644 Supabase \u0628\u0627\u0633\u062A\u062E\u062F\u0627\u0645 \u0645\u0641\u062A\u0627\u062D \u0627\u0644\u062F\u0648\u0631 \u0627\u0644\u062E\u062F\u0645\u064A (server-side \u0641\u0642\u0637)\r\n    const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE);\r\n\r\n    // \u26A0\uFE0F \u0628\u0639\u0636 \u0627\u0644\u0625\u0635\u062F\u0627\u0631\u0627\u062A \u0644\u0627 \u062A\u062F\u0639\u0645 \u062A\u0645\u0631\u064A\u0631 \u0645\u062F\u0629 \u0635\u0644\u0627\u062D\u064A\u0629 \u0647\u0646\u0627 \u2014 \u0633\u0646\u062D\u0627\u0648\u0644 30 \u062F\u0642\u064A\u0642\u0629\u060C \u0648\u0625\u0646 \u062A\u062C\u0627\u0647\u0644\u062A\u0647\u0627 \u0627\u0644\u0645\u0643\u062A\u0628\u0629 \u0641\u0633\u062A\u0633\u062A\u062E\u062F\u0645 \u0627\u0644\u0627\u0641\u062A\u0631\u0627\u0636\u064A.\r\n    // \u0625\u0646 \u0643\u0627\u0646 \u0625\u0635\u062F\u0627\u0631\u0643 \u0644\u0627 \u064A\u0642\u0628\u0644 \u0648\u0633\u064A\u0637\u0627\u064B \u062B\u0627\u0646\u064A\u0627\u064B\u060C \u0633\u064A\u064F\u0647\u0645\u0644 \u0628\u062F\u0648\u0646 \u0645\u0634\u0627\u0643\u0644.\r\n    const THIRTY_MINUTES = 60 * 30;\r\n    const { data, error } = await supabase.storage\r\n      .from(SUPABASE_BUCKET)\r\n      .createSignedUploadUrl(objectPath, THIRTY_MINUTES);\r\n\r\n    if (error) {\r\n      console.error(\"[SIGNED UPLOAD URL ERROR]\", error);\r\n      return cors({\r\n        statusCode: 500,\r\n        body: JSON.stringify({ error: error.message }),\r\n      });\r\n    }\r\n\r\n    // \u062D\u0636\u0651\u0631 \u0631\u0627\u0628\u0637 PUT \u0627\u0644\u062C\u0627\u0647\u0632 \u0644\u0644\u0631\u0641\u0639 \u0645\u0646 \u0627\u0644\u0645\u062A\u0635\u0641\u062D + \u0627\u0644\u062A\u0648\u0643\u0646\r\n    const uploadUrl = `${SUPABASE_URL}/storage/v1/object/upload/sign/${objectPath}`;\r\n\r\n    // \u0645\u0639\u0644\u0648\u0645\u0627\u062A \u0625\u0631\u0634\u0627\u062F\u064A\u0629 \u0644\u0644\u0648\u0627\u062C\u0647\u0629\r\n    const resp = {\r\n      path: objectPath,            // \u062E\u0632\u0651\u0646\u0647 \u0645\u0639 \u0627\u0644\u0634\u0643\u0648\u0649 (\u0644\u0627 \u062D\u0627\u062C\u0629 \u0644\u062D\u0641\u0638 \u0631\u0627\u0628\u0637 \u0645\u0624\u0642\u0651\u062A)\r\n      token: data?.token,          // \u0636\u0639\u0647 \u0641\u064A \u0647\u064A\u062F\u0631 Authorization \u0639\u0646\u062F \u0627\u0644\u0631\u0641\u0639\r\n      uploadUrl,                   // \u0647\u0630\u0627 \u0647\u0648 endpoint \u0627\u0644\u0630\u064A \u0633\u062A\u0631\u0641\u0639 \u0639\u0644\u064A\u0647 \u0645\u0628\u0627\u0634\u0631\u0629\r\n      contentType: mime,           // \u0627\u0633\u062A\u062E\u062F\u0645\u0647 \u0643\u0647\u064A\u062F\u0631 Content-Type \u0641\u064A \u0637\u0644\u0628 PUT\r\n      maxBytes: MAX_BYTES,         // \u0644\u0644\u0648\u0627\u062C\u0647\u0629 \u0641\u0642\u0637 (\u062A\u0630\u0643\u064A\u0631 \u0628\u0627\u0644\u062D\u062C\u0645)\r\n      // \u0648\u0642\u062A \u0627\u0644\u0627\u0646\u062A\u0647\u0627\u0621 \u062A\u0642\u062F\u064A\u0631\u064A: \u0627\u0644\u0622\u0646 + 30 \u062F\u0642\u064A\u0642\u0629 (\u0642\u062F \u064A\u062E\u062A\u0644\u0641 \u0641\u0639\u0644\u064A\u0627\u064B \u062D\u0633\u0628 \u0625\u0635\u062F\u0627\u0631 \u0627\u0644\u0645\u0643\u062A\u0628\u0629)\r\n      expiresAt: Date.now() + THIRTY_MINUTES * 1000,\r\n    };\r\n\r\n    return cors({ statusCode: 200, body: JSON.stringify(resp) });\r\n  } catch (err) {\r\n    console.error(\"[getUploadTicket ERROR]\", err);\r\n    return cors({\r\n      statusCode: 500,\r\n      body: JSON.stringify({ error: err.message || String(err) }),\r\n    });\r\n  }\r\n}\r\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA,yBAA6B;AAEtB,IAAM,SAAS,EAAE,MAAM,sCAAsC;AAEpE,SAAS,KAAK,KAAK;AACjB,SAAO;AAAA,IACL,GAAG;AAAA,IACH,SAAS;AAAA,MACP,+BAA+B;AAAA,MAC/B,gCAAgC;AAAA,MAChC,gCAAgC;AAAA,MAChC,gBAAgB;AAAA,IAClB;AAAA,EACF;AACF;AAEA,IAAM,EAAE,cAAc,uBAAuB,gBAAgB,IAAI,QAAQ;AAGzE,IAAM,UAAU,oBAAI,IAAI,CAAC,mBAAmB,aAAa,YAAY,CAAC;AACtE,IAAM,YAAY,KAAK,OAAO;AAE9B,eAAsB,QAAQ,OAAO;AACnC,MAAI;AACF,QAAI,MAAM,eAAe,WAAW;AAClC,aAAO,KAAK,EAAE,YAAY,KAAK,MAAM,GAAG,CAAC;AAAA,IAC3C;AACA,QAAI,MAAM,eAAe,QAAQ;AAC/B,aAAO,KAAK;AAAA,QACV,YAAY;AAAA,QACZ,MAAM,KAAK,UAAU,EAAE,OAAO,qBAAqB,CAAC;AAAA,MACtD,CAAC;AAAA,IACH;AAEA,QAAI,CAAC,gBAAgB,CAAC,yBAAyB,CAAC,iBAAiB;AAC/D,aAAO,KAAK;AAAA,QACV,YAAY;AAAA,QACZ,MAAM,KAAK,UAAU,EAAE,OAAO,4BAA4B,CAAC;AAAA,MAC7D,CAAC;AAAA,IACH;AAGA,UAAM,EAAE,OAAO,kBAAkB,IAAI,KAAK,MAAM,MAAM,QAAQ,IAAI;AAGlE,QAAI,CAAC,QAAQ,IAAI,IAAI,GAAG;AACtB,aAAO,KAAK;AAAA,QACV,YAAY;AAAA,QACZ,MAAM,KAAK,UAAU;AAAA,UACnB,OAAO;AAAA,QACT,CAAC;AAAA,MACH,CAAC;AAAA,IACH;AAEA,UAAM,MACJ,SAAS,oBACL,QACA,SAAS,cACT,QACA;AAGN,UAAM,aAAa,UAAU,KAAK,IAAI,CAAC,IAAI,KAAK,OAAO,EACpD,SAAS,EAAE,EACX,MAAM,CAAC,CAAC,IAAI,GAAG;AAGlB,UAAM,eAAW,iCAAa,cAAc,qBAAqB;AAIjE,UAAM,iBAAiB,KAAK;AAC5B,UAAM,EAAE,MAAM,MAAM,IAAI,MAAM,SAAS,QACpC,KAAK,eAAe,EACpB,sBAAsB,YAAY,cAAc;AAEnD,QAAI,OAAO;AACT,cAAQ,MAAM,6BAA6B,KAAK;AAChD,aAAO,KAAK;AAAA,QACV,YAAY;AAAA,QACZ,MAAM,KAAK,UAAU,EAAE,OAAO,MAAM,QAAQ,CAAC;AAAA,MAC/C,CAAC;AAAA,IACH;AAGA,UAAM,YAAY,GAAG,YAAY,kCAAkC,UAAU;AAG7E,UAAM,OAAO;AAAA,MACX,MAAM;AAAA;AAAA,MACN,OAAO,MAAM;AAAA;AAAA,MACb;AAAA;AAAA,MACA,aAAa;AAAA;AAAA,MACb,UAAU;AAAA;AAAA;AAAA,MAEV,WAAW,KAAK,IAAI,IAAI,iBAAiB;AAAA,IAC3C;AAEA,WAAO,KAAK,EAAE,YAAY,KAAK,MAAM,KAAK,UAAU,IAAI,EAAE,CAAC;AAAA,EAC7D,SAAS,KAAK;AACZ,YAAQ,MAAM,2BAA2B,GAAG;AAC5C,WAAO,KAAK;AAAA,MACV,YAAY;AAAA,MACZ,MAAM,KAAK,UAAU,EAAE,OAAO,IAAI,WAAW,OAAO,GAAG,EAAE,CAAC;AAAA,IAC5D,CAAC;AAAA,EACH;AACF;",
  "names": []
}
