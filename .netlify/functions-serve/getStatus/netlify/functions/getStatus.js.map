{
  "version": 3,
  "sources": ["../../../../Desktop/civic-complaints-backup/netlify/functions/getStatus.js"],
  "sourceRoot": "C:/Users/PC/AppData/Local/Temp/tmp-11528-0o1uDxELhDuF",
  "sourcesContent": ["// netlify/functions/getStatus.js\r\nexport const config = { path: \"/.netlify/functions/getStatus\" };\r\n\r\nfunction cors(res) {\r\n  return {\r\n    ...res,\r\n    headers: {\r\n      \"Access-Control-Allow-Origin\": \"*\",\r\n      \"Access-Control-Allow-Headers\": \"Content-Type, Authorization\",\r\n      \"Access-Control-Allow-Methods\": \"GET,OPTIONS\",\r\n      \"Content-Type\": \"application/json\",\r\n    },\r\n  };\r\n}\r\n\r\nfunction labelVal(labels, prefix) {\r\n  const l = (labels || []).find((x) => (x.name || \"\").startsWith(prefix));\r\n  return l ? (l.name.split(\":\")[1] || \"\").trim() : \"\";\r\n}\r\n\r\nexport async function handler(event) {\r\n  if (event.httpMethod === \"OPTIONS\") return cors({ statusCode: 200, body: \"\" });\r\n  if (event.httpMethod !== \"GET\") {\r\n    return cors({ statusCode: 405, body: JSON.stringify({ error: \"Method Not Allowed\" }) });\r\n  }\r\n\r\n  const { REPO_OWNER, REPO_NAME, GITHUB_TOKEN } = process.env;\r\n  if (!REPO_OWNER || !REPO_NAME || !GITHUB_TOKEN) {\r\n    return cors({ statusCode: 500, body: JSON.stringify({ error: \"Missing server env\" }) });\r\n  }\r\n\r\n  try {\r\n    const numRaw = event.queryStringParameters?.number;\r\n    const num = Number(numRaw);\r\n    if (!num || !Number.isFinite(num) || num <= 0) {\r\n      return cors({ statusCode: 422, body: JSON.stringify({ error: \"invalid number\" }) });\r\n    }\r\n\r\n    const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${num}`;\r\n    const res = await fetch(url, {\r\n      headers: {\r\n        \"Authorization\": `Bearer ${GITHUB_TOKEN}`,\r\n        \"Accept\": \"application/vnd.github+json, application/vnd.github.squirrel-girl-preview+json\",\r\n      },\r\n    });\r\n\r\n    if (!res.ok) {\r\n      const t = await res.text();\r\n      return cors({ statusCode: res.status === 404 ? 404 : 500, body: JSON.stringify({ error: t || \"not found\" }) });\r\n    }\r\n\r\n    const issue = await res.json();\r\n\r\n    // \u0627\u0633\u062A\u062E\u0631\u0627\u062C \u0645\u0639\u0644\u0648\u0645\u0627\u062A \u0644\u0644\u0639\u0631\u0636\r\n    const labels = issue.labels || [];\r\n    const type = labelVal(labels, \"type:\");\r\n    const topic = labelVal(labels, \"topic:\");\r\n    const city  = labelVal(labels, \"city:\");\r\n\r\n    // \u0644\u0644\u0634\u0643\u0648\u0649 \u0646\u0639\u0631\u0636 \u0627\u0644\u0645\u0644\u062E\u0651\u0635 \u0641\u0642\u0637\u060C \u0644\u0644\u062A\u0642\u0631\u064A\u0631 \u0646\u0639\u0631\u0636 \u0645\u0642\u062A\u0637\u0641\u064B\u0627\r\n    const body = issue.body || \"\";\r\n    let display = \"\";\r\n    if (type === \"complaint\") {\r\n      const line = (body.split(\"\\n\").find((l) => l.startsWith(\"**\u0645\u0644\u062E\u0635**:\")) || \"\");\r\n      display = (line.replace(\"**\u0645\u0644\u062E\u0635**:\", \"\").trim()) || \"\u2014\";\r\n    } else {\r\n      display = body.replace(/\\r?\\n/g, \" \").slice(0, 240) + (body.length > 240 ? \"\u2026\" : \"\");\r\n    }\r\n\r\n    // \u0645\u0639\u0644\u0648\u0645\u0627\u062A \u0625\u0636\u0627\u0641\u064A\u0629 \u0627\u062E\u062A\u064A\u0627\u0631\u064A\u0629\r\n    const comments = issue.comments ?? 0;\r\n    const reactions = typeof issue.reactions?.[\"+1\"] === \"number\"\r\n      ? issue.reactions[\"+1\"]\r\n      : (issue.reactions?.total_count ?? 0);\r\n\r\n    const payload = {\r\n      number: issue.number,\r\n      title: issue.title,\r\n      html_url: issue.html_url,\r\n      created_at: issue.created_at,\r\n      labels: labels.map((l) => ({ name: l.name })),\r\n      type, topic, city,\r\n      display,\r\n      comments,\r\n      reactions,\r\n    };\r\n\r\n    return cors({ statusCode: 200, body: JSON.stringify(payload) });\r\n  } catch (e) {\r\n    return cors({ statusCode: 500, body: JSON.stringify({ error: e.message || String(e) }) });\r\n  }\r\n}\r\n"],
  "mappings": "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",
  "names": []
}
