<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ููุตุฉ ุงูุดูุงูุงุช ูุงูุชูุงุฑูุฑ</title>
  <meta name="description" content="ุชูุซูู ุงูุดูุงูุงุช ูุงูุชูุงุฑูุฑ ุงูุฌูุงุนูุฉ ูุน ุดูุงุฏุงุช ุฏุงุนูุฉ ููููุงุช ูููุนุฉ.">
  <style>
    :root { --gap: 14px; }
    body{font-family:system-ui,Arial;max-width:1100px;margin:24px auto;padding:0 12px;line-height:1.8;background:#fff}
    header{display:flex;flex-wrap:wrap;gap:var(--gap);align-items:center;justify-content:space-between;margin-bottom:10px}
    h1{margin:0}
    .muted{color:#666;font-size:.92em}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{padding:10px 14px;border:0;border-radius:12px;background:#111;color:#fff;cursor:pointer}
    .btn.outline{background:#fff;color:#111;border:1px solid #ddd}
    .tabs{display:flex;gap:8px;margin:10px 0}
    .tab-btn{padding:10px 14px;border:1px solid #ddd;border-radius:999px;background:#f9f9f9;cursor:pointer}
    .tab-btn.active{background:#111;color:#fff;border-color:#111}
    .card{border:1px solid #e6e6e6;border-radius:14px;padding:14px;margin:14px 0;background:#fff}
    label{display:block;margin:8px 0 4px}
    input,select,textarea{width:100%;padding:10px;border:1px solid #ccc;border-radius:10px;background:#fff}
    textarea{resize:vertical}
    .grid{display:grid;gap:var(--gap);grid-template-columns:repeat(auto-fill,minmax(300px,1fr))}
    .badge{display:inline-block;background:#f3f3f3;border:1px solid #e6e6e6;border-radius:999px;padding:2px 10px;font-size:.85em;margin-inline:4px 0}
    .pill{background:#fff;border:1px solid #ddd;border-radius:999px;padding:4px 10px}
    .cta{position:sticky;bottom:12px;display:flex;justify-content:center;margin-top:18px}
    details summary{cursor:pointer}
    .hint{background:#fafafa;border:1px dashed #ddd;border-radius:10px;padding:10px;margin-top:6px}
    .sep{height:1px;background:#eee;margin:10px 0}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>ููุตุฉ ุงูุดูุงูุงุช ูุงูุชูุงุฑูุฑ</h1>
      <div class="muted">ุชููุดุฑ ุงูุดูุงูุงุช ุจููุฎุต ููุทุ ูุงููุซุงุฆู ุงููููุนุฉ ุชูุญูุธ ูุฏู ุงูุฅุฏุงุฑุฉ ููุง ุชููุชุญ ููุนุงูุฉ. ุงูุชูุงุฑูุฑ ุชูุนุฑุถ ูุงููุฉ ูุง ูู ุชุชุถูู ุจูุงูุงุช ุญุณุงุณุฉ.</div>
    </div>
    <div class="row">
      <button id="toComplaints" class="btn">โ ุฅุถุงูุฉ ุดููู</button>
      <button id="toReports" class="btn outline">๐ ุฅุถุงูุฉ ุชูุฑูุฑ</button>
    </div>
  </header>

  <!-- ุชุจููุจ ุงูููุงุฐุฌ -->
  <section class="tabs">
    <button class="tab-btn active" data-tab="complaintTab">ูููุฐุฌ ุดููู</button>
    <button class="tab-btn" data-tab="reportTab">ูููุฐุฌ ุชูุฑูุฑ</button>
  </section>

  <!-- ูููุฐุฌ ุงูุดููู -->
  <section id="complaintTab" class="card">
    <h2>ุฅูุฏุงุน ุดููู (ููููุนุฉ)</h2>
    <p class="muted">ูู ุชููุจู ุงูุดููู ุจุฏูู ุฑูุน ูุซููุฉ/ุตูุฑุฉ ูููุนุฉ ุจุฎุท ุงููุฏ. ุณูุธูุฑ ููุนููู <b>ููุฎุต ุงูุดููู ููุท</b> ูุงุณูู ุญุณุจ ุฑุบุจุชู.</p>

    <form id="complaintForm">
      <input type="text" name="website" style="position:absolute;left:-9999px" tabindex="-1" autocomplete="off" />
      <label>ุงูุงุณู ุงููุงูู</label>
      <input name="fullName" required placeholder="ุงูุงุณู ููุง ูู ุงูุจุทุงูุฉ" />

      <label>ุฅุธูุงุฑ ุงูุงุณู ููุนูููุ</label>
      <select name="showName" required>
        <option value="yes">ูุนูุ ุงุนุฑุถ ุงุณูู</option>
        <option value="no">ูุงุ ุฃุฎูู ุงุณูู</option>
      </select>

      <label>ุชุงุฑูุฎ ุชูุฏูู ุงูุดููู</label>
      <input type="date" name="submittedDate" required />

      <label>ููุน ุงูุดููู</label>
      <select name="category" required>
        <option value="">โ ุงุฎุชุฑ โ</option>
        <option>ุดุนุงุฆุฑ</option>
        <option>ุถูุถุงุก</option>
        <option>ูุธุงูุฉ</option>
        <option>ูุณุงุฏ ุฅุฏุงุฑู</option>
        <option>ุฃุฎุฑู</option>
      </select>

      <label>ุงููุฏููุฉ/ุงูููุงู (ุงุฎุชูุงุฑู)</label>
      <input name="place" placeholder="ูุซุงู: ูุงุณ - ูุณุฌุฏ ..." />

      <label>ููุฎุต ุงูุดููู (ุณูููุดุฑ ููุนูููุ 120โ400 ุญุฑู)</label>
      <textarea name="summary" rows="4" minlength="120" maxlength="400" required placeholder="ุงูุชุจ ุฎูุงุตุฉ ุฏูููุฉ ูููุถูุนูุฉ ุฏูู ุจูุงูุงุช ุดุฎุตูุฉ ูุฃุทุฑุงู ุฃุฎุฑู."></textarea>

      <div class="hint">ุงููุต ุงูุชูุตููู ุงููุงูู ููุฌูุฏ ุฏุงุฎู ุงููุซููุฉ ุงููููุนุฉ ุงูุชู ุณุชุฑูุนูุง.</div>

      <label>ูุซููุฉ/ุตูุฑุฉ ุงูุดููู ุงููููุนุฉ (PDF/PNG/JPG โค 10MB) โ ุฅูุฒุงูู</label>
      <input type="file" name="proofFile" accept=".pdf,image/png,image/jpeg" required />

      <div class="row">
        <button type="submit" class="btn">ุฅุฑุณุงู ุงูุดููู</button>
        <span id="complaintStatus" class="muted"></span>
      </div>
    </form>
  </section>

  <!-- ูููุฐุฌ ุงูุชูุฑูุฑ -->
  <section id="reportTab" class="card" style="display:none">
    <h2>ุฅุถุงูุฉ ุชูุฑูุฑ ุฑุตุฏ</h2>
    <p class="muted">ุงูุชูุงุฑูุฑ ุชูุนุฑุถ ูุงููุฉ ููุนููู (ูุน ูุฑุงุนุงุฉ ุงูุฎุตูุตูุฉ). ุงุฐูุฑ ุงูููุงุฆุน ุจุฏูุฉ ูุฒูููุง ูููุงููุง.</p>

    <form id="reportForm">
      <input type="text" name="website" style="position:absolute;left:-9999px" tabindex="-1" autocomplete="off" />
      <label>ุงูุงุณู ุงููุงูู (ุงุฎุชูุงุฑู ููุนุฑุถ ุงูุนููู)</label>
      <input name="fullName" placeholder="ูููู ุชุฑูู ูุงุฑุบูุง ุฅู ุฑุบุจุช" />

      <label>ุชุงุฑูุฎ/ููุช ุงููุงูุนุฉ</label>
      <input type="datetime-local" name="eventDateTime" required />

      <label>ุงูููุงู</label>
      <input name="place" required placeholder="ูุณุฌุฏ/ุญู/ุนููุงู" />

      <label>ุงูุชุตููู</label>
      <select name="category" required>
        <option value="">โ ุงุฎุชุฑ โ</option>
        <option>ุดุนุงุฆุฑ</option>
        <option>ุถูุถุงุก</option>
        <option>ูุธุงูุฉ</option>
        <option>ูุณุงุฏ ุฅุฏุงุฑู</option>
        <option>ุฃุฎุฑู</option>
      </select>

      <label>ูุต ุงูุชูุฑูุฑ (โฅ 120 ุญุฑููุง)</label>
      <textarea name="body" rows="6" minlength="120" required placeholder="ูุตู ููุถูุนู ูููุงูุนุฉ: ูุงุฐุง ุญุฏุซุ ูุชูุ ุฃููุ"></textarea>

      <label>ุฑูุงุจุท ุฃุฏูุฉ (ุงุฎุชูุงุฑู)</label>
      <input name="evidenceUrl" type="url" placeholder="https://..." />

      <div class="row">
        <button type="submit" class="btn">ุฅุฑุณุงู ุงูุชูุฑูุฑ</button>
        <span id="reportStatus" class="muted"></span>
      </div>
    </form>
  </section>

  <!-- ููุงุชุฑ ุงููุนุฑุถ -->
  <section class="card">
    <h2>ุงููุนุฑูุถ ููุนุงูุฉ</h2>
    <div class="row" style="margin-top:6px">
      <select id="typeFilter">
        <option value="">ุงููู</option>
        <option value="complaint">ุดูุงูู (ููุฎุตุงุช)</option>
        <option value="report">ุชูุงุฑูุฑ (ูุต ูุงูู)</option>
      </select>
      <select id="topicFilter">
        <option value="">ูู ุงูููุงุถูุน</option>
        <option>ุดุนุงุฆุฑ</option>
        <option>ุถูุถุงุก</option>
        <option>ูุธุงูุฉ</option>
        <option>ูุณุงุฏ ุฅุฏุงุฑู</option>
        <option>ุฃุฎุฑู</option>
      </select>
      <input id="cityFilter" placeholder="ูุฏููุฉ/ููุงู" />
      <select id="sortBy">
        <option value="newest">ุงูุฃุญุฏุซ ุฃููุงู</option>
        <option value="supporters">ุงูุฃูุซุฑ ูุคูุฏูู</option>
      </select>
      <button id="applyFilters" class="btn outline">ุชุทุจูู ุงูููุงุชุฑ</button>
    </div>
    <div id="stats" class="row" style="margin-top:10px"></div>
    <div id="list" class="grid" aria-live="polite" style="margin-top:10px"></div>
    <div class="cta"><button id="addQuick" class="btn">ูุฏูู ูุดุงุฑูุชู ุงูุขู</button></div>
  </section>

  <div class="sep"></div>
  <footer class="muted">
    <p>ุชูุจูู: ูุง ุชูุนุฑุถ ุงููุซุงุฆู/ุงูุชูููุนุงุช ุนูููุง. ุชูุญูุธ ูุฏู ุงูุฅุฏุงุฑุฉ ููุท ูุฅุซุจุงุช.</p>
  </footer>

<script>
/* === ุงุถุจุท ูุฐู ุงููุชุบูุฑุงุช === */
const REPO_OWNER = "YOUR_GH_USERNAME";
const REPO_NAME  = "YOUR_REPO_NAME";
const API_BASE   = "https://api.github.com";
const FN_BASE    = "https://YOUR_NETLIFY_SITE.netlify.app/.netlify/functions";

/* ุชุจููุจ ุงูููุงุฐุฌ */
const tabs = document.querySelectorAll(".tab-btn");
tabs.forEach(btn=>btn.onclick=()=>{
  tabs.forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  document.getElementById("complaintTab").style.display = btn.dataset.tab==="complaintTab" ? "" : "none";
  document.getElementById("reportTab").style.display = btn.dataset.tab==="reportTab" ? "" : "none";
});
document.getElementById("toComplaints").onclick = ()=>tabs[0].click();
document.getElementById("toReports").onclick   = ()=>tabs[1].click();
document.getElementById("addQuick").onclick    = ()=>tabs[0].click();

/* Helpers */
function labelValue(labels, prefix){
  const l = (labels||[]).find(x=>{
    const n = (x.name||x).toString();
    return n.startsWith(prefix);
  });
  return l ? (l.name||l).split(":")[1].trim() : "";
}
function cardFor(issue){
  const labels = issue.labels || [];
  const type = labelValue(labels, "type:");
  const topic = labelValue(labels, "topic:");
  const city  = labelValue(labels, "city:");
  const created = new Date(issue.created_at);
  const supporters = issue.comments || 0;
  const url = issue.html_url;

  // ุจุงููุณุจุฉ ููุดูุงูุงุช ููุดุฑ ุงูููุฎุต ููุท (ููุฌูุฏ ุฏุงุฎู body ููุต ูุฎุชุตุฑ)
  const body = (issue.body||"");
  const summary = body.split("\n").find(l=>l.startsWith("**ููุฎุต**:")) || "";
  const summaryText = summary.replace("**ููุฎุต**:","").trim();

  // ุงูุชูุงุฑูุฑ ุชุนุฑุถ ูุตูุง ูุงููุงู (ูุตูู ูุจุทุงูุฉ ุงูุนุฑุถ ููุท)
  const excerpt = (body||"").replace(/\r?\n/g," ").slice(0,240) + ((body||"").length>240?"โฆ":"");

  const title = (issue.title||"ููู");
  const badgeType = type==="complaint" ? "ุดููู (ููุฎุต)" : type==="report" ? "ุชูุฑูุฑ" : "ููู";
  const content = (type==="complaint") ? summaryText : excerpt;

  return `
  <article class="card">
    <div class="row">
      <span class="badge">${badgeType}</span>
      ${topic?`<span class="badge">ููุถูุน: ${topic}</span>`:""}
      ${city?`<span class="badge">ุงูููุงู: ${city}</span>`:""}
      <span class="badge">#${issue.number}</span>
    </div>
    <h3 style="margin:6px 0 0"><a href="${url}" target="_blank" rel="noopener">${title}</a></h3>
    <div class="muted">${created.toLocaleDateString()} โข ูุคูุฏูู: ${supporters}</div>
    <p>${content || "โ"}</p>
    <div class="row">
      <a class="pill" href="${url}" target="_blank" rel="noopener">ูุชุญ ุนูู GitHub</a>
      <a class="pill" href="${url}#new_comment_field" target="_blank" rel="noopener">ุฃุถู ุดูุงุฏุฉ/ุชุนููู</a>
      <button class="pill" onclick="copyShare('${location.origin}${location.pathname}?ref=${issue.number}')">ูุณุฎ ุฑุงุจุท ุงููุดุงุฑูุฉ</button>
    </div>
  </article>`;
}
function copyShare(t){ navigator.clipboard.writeText(t).then(()=>alert("ุชู ูุณุฎ ุงูุฑุงุจุท")); }

/* ุฌูุจ ุงููุนุฑูุถ ููุนุงูุฉ (approved) */
async function fetchApproved(page=1, acc=[]){
  const url = `${API_BASE}/repos/${REPO_OWNER}/${REPO_NAME}/issues?state=open&labels=approved&per_page=100&page=${page}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error("GitHub API error");
  const batch = (await res.json()).filter(i=>!i.pull_request);
  acc.push(...batch);
  if(batch.length===100) return fetchApproved(page+1, acc);
  return acc;
}
function applyFilters(items){
  const t = document.getElementById("typeFilter").value;
  const topic = document.getElementById("topicFilter").value;
  const city  = document.getElementById("cityFilter").value.trim();
  const sort  = document.getElementById("sortBy").value;

  let r = items.slice();
  if(t){
    r = r.filter(it => labelValue(it.labels,"type:") === t);
  }
  if(topic){
    r = r.filter(it => labelValue(it.labels,"topic:") === topic);
  }
  if(city){
    const cityOf = it => labelValue(it.labels,"city:");
    r = r.filter(it => cityOf(it).toLowerCase().includes(city.toLowerCase()));
  }
  if(sort==="supporters"){
    r.sort((a,b)=>(b.comments||0)-(a.comments||0));
  }else{
    r.sort((a,b)=> new Date(b.created_at)-new Date(a.created_at));
  }
  return r;
}
async function renderList(){
  const list = document.getElementById("list");
  const stats = document.getElementById("stats");
  list.innerHTML = "<p class='muted'>โฆ ุฌุงุฑู ุงูุชุญููู</p>";
  try{
    const items = await fetchApproved();
    const filtered = applyFilters(items);
    stats.innerHTML = `
      <span class="badge">ุฅุฌูุงูู ุงููููุงุช: ${items.length}</span>
      <span class="badge">ุงููุนุฑูุถุฉ: ${filtered.length}</span>`;
    list.innerHTML = filtered.map(cardFor).join("") || "<p class='muted'>ูุง ุชูุฌุฏ ุนูุงุตุฑ ุจุนุฏ.</p>";

    // ุงูุชุญ ุงูุชุนููู ูุจุงุดุฑุฉ ูู ref ููุฌูุฏ
    const params = new URLSearchParams(location.search);
    const ref = params.get("ref");
    if(ref) window.open(`https://github.com/${REPO_OWNER}/${REPO_NAME}/issues/${ref}#new_comment_field`,"_blank");
  }catch(e){
    list.innerHTML = "<p class='muted'>ุชุนุฐูุฑ ุชุญููู ุงููุนุฑูุถ.</p>";
    console.error(e);
  }
}
document.getElementById("applyFilters").onclick = renderList;

/* ุฅุฑุณุงู ุงูุดููู (ูุน ุฑูุน ูุฑูู ุฅูุฒุงูู) */
document.getElementById("complaintForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const form = e.target;
  const fd = new FormData(form);
  if(fd.get("website")) return; // trap

  const status = document.getElementById("complaintStatus");
  status.textContent = "ุฌุงุฑู ุงูุฑูุน ูุงูุชุญููโฆ";

  // ุฑูุน ุงูููู ุฃูููุง
  const file = fd.get("proofFile");
  if(!file || file.size===0){
    status.textContent = "ุงูููู ุงูููููุน ูุทููุจ.";
    return;
  }
  const upFd = new FormData();
  upFd.append("file", file, file.name);
  const upRes = await fetch(`${FN_BASE}/uploadProof`, { method:"POST", body: upFd });
  if(!upRes.ok){
    status.textContent = "ุชุนุฐูุฑ ุฑูุน ุงูููู. ุชุญููู ูู ุงูููุน/ุงูุญุฌู.";
    return;
  }
  const upJson = await upRes.json();
  const proofUrl = upJson.url || ""; // ููููุช/ุฎุงุต

  // ุฅุฑุณุงู ุงูุดููู
  const payload = {
    fullName: fd.get("fullName"),
    showName: fd.get("showName"),
    submittedDate: fd.get("submittedDate"),
    category: fd.get("category"),
    place: fd.get("place"),
    summary: fd.get("summary"),
    proofUrl
  };
  const r = await fetch(`${FN_BASE}/submitComplaint`, {
    method:"POST", headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });
  status.textContent = r.ok ? "ุชู ุงุณุชูุงู ุงูุดููู ูููุฑุงุฌุนุฉ." : "ุชุนุฐูุฑ ุฅุฑุณุงู ุงูุดููู.";
  if(r.ok){ form.reset(); renderList(); }
});

/* ุฅุฑุณุงู ุงูุชูุฑูุฑ */
document.getElementById("reportForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const form = e.target;
  const fd = new FormData(form);
  if(fd.get("website")) return;

  const status = document.getElementById("reportStatus");
  status.textContent = "ุฌุงุฑู ุงูุฅุฑุณุงูโฆ";

  const payload = {
    fullName: fd.get("fullName"),
    eventDateTime: fd.get("eventDateTime"),
    place: fd.get("place"),
    category: fd.get("category"),
    body: fd.get("body"),
    evidenceUrl: fd.get("evidenceUrl")
  };
  const r = await fetch(`${FN_BASE}/submitReport`, {
    method:"POST", headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });
  status.textContent = r.ok ? "ุชู ุงุณุชูุงู ุงูุชูุฑูุฑ ูููุฑุงุฌุนุฉ." : "ุชุนุฐูุฑ ุฅุฑุณุงู ุงูุชูุฑูุฑ.";
  if(r.ok){ form.reset(); renderList(); }
});

/* ุจุฏุก ุงูุนุฑุถ */
renderList();
</script>
</body>
</html>
