<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…Ù†ØµØ© Ø§Ù„Ø´ÙƒØ§ÙŠØ§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</title>
  <meta name="description" content="ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø´ÙƒØ§ÙŠØ§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ© Ù…Ø¹ Ø´Ù‡Ø§Ø¯Ø§Øª Ø¯Ø§Ø¹Ù…Ø© ÙˆÙ…Ù„ÙØ§Øª Ù…ÙˆÙ‚Ø¹Ø©.">

  <!-- Content Security Policy (Ù…Ø¨Ø³Ù‘Ø·Ø© Ù…Ø¹ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù€ inline Ù„ØªÙˆØ§ÙÙ‚ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ) -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://js.hcaptcha.com https://hcaptcha.com https://esm.sh;
    connect-src 'self' https://api.github.com https://hcaptcha.com https://*.hcaptcha.com https://*.supabase.co https://*.netlify.app;
    img-src 'self' data: https:;
    style-src 'self' 'unsafe-inline';
    font-src 'self' data:;
    frame-src https://hcaptcha.com https://*.hcaptcha.com;
    base-uri 'self';
    form-action 'self';
  ">

  <style>
    :root { --gap: 14px; }
    body{font-family:system-ui,Arial;max-width:1100px;margin:24px auto;padding:0 12px;line-height:1.8;background:#fff}
    header{display:flex;flex-wrap:wrap;gap:var(--gap);align-items:center;justify-content:space-between;margin-bottom:10px}
    .muted{color:#666;font-size:.92em}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{padding:10px 14px;border:0;border-radius:12px;background:#111;color:#fff;cursor:pointer}
    .btn.outline{background:#fff;color:#111;border:1px solid #ddd}
    .tabs{display:flex;gap:8px;margin:10px 0;flex-wrap:wrap}
    .tab-btn{padding:10px 14px;border:1px solid #ddd;border-radius:999px;background:#f9f9f9;cursor:pointer}
    .tab-btn.active{background:#111;color:#fff;border-color:#111}
    .card{border:1px solid #e6e6e6;border-radius:14px;padding:14px;margin:14px 0;background:#fff}
    label{display:block;margin:8px 0 4px}
    input,select,textarea{width:100%;padding:10px;border:1px solid #ccc;border-radius:10px;background:#fff}
    textarea{resize:vertical}
    .grid{display:grid;gap:var(--gap);grid-template-columns:repeat(auto-fill,minmax(300px,1fr))}
    .badge{display:inline-block;background:#f3f3f3;border:1px solid #e6e6e6;border-radius:999px;padding:2px 10px;font-size:.85em;margin-inline:4px 0}
    .pill{background:#fff;border:1px solid #ddd;border-radius:999px;padding:4px 10px}
    .cta{position:sticky;bottom:12px;display:flex;justify-content:center;margin-top:18px}
    details summary{cursor:pointer}
    .hint{background:#fafafa;border:1px dashed #ddd;border-radius:10px;padding:10px;margin-top:6px}
    .sep{height:1px;background:#eee;margin:10px 0}
    .actions{display:flex;gap:8px;flex-wrap:wrap}

    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‡ÙŠØ¯Ø± */
    .nav-actions { display:flex;gap:8px;margin-top:8px;margin-inline-start:auto; }
    .nav-btn { padding:6px 12px;border:1px solid #ccc;border-radius:8px;background:#f9f9f9;font-size:0.9rem;cursor:pointer;text-decoration:none;color:#111;transition:.2s; }
    .nav-btn:hover { background:#111;color:#fff;border-color:#111; }

    /* Ø¹Ù†ÙˆØ§Ù† */
    .title-card { background:#f9f9f9;border:1px solid #ddd;border-radius:12px;padding:16px 20px;box-shadow:0 2px 6px rgba(0,0,0,0.08);margin:0 auto 12px;text-align:center;width:100% }
    .title-card h1 { margin:0 0 6px;font-size:1.8rem;color:#0a0a0a }
    .title-card .muted { text-align:center;font-size:0.92rem;color:#555 }

    /* Ø¹Ù†Ø§ÙˆÙŠÙ† ÙØ±Ø¹ÙŠØ© */
    .section-title { background:#f9f9f9;border:1px solid #ddd;border-radius:10px;padding:12px 16px;margin-bottom:14px;box-shadow:0 2px 5px rgba(0,0,0,0.07);text-align:right }
    .section-title h2 { margin:0;font-size:1.4rem;color:#0a0a0a }

    /* ØªÙŠÙ„Ø¬Ø±Ø§Ù… */
    .telegram-fab { position:fixed;bottom:20px;left:20px;background:#0088cc;border-radius:50%;width:54px;height:54px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(0,0,0,.2);animation:pulse 1.5s infinite;z-index:999 }
    .telegram-fab:hover { background:#006fa1 }
    @keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.1)} 100%{transform:scale(1)} }
  </style>

  <!-- hCaptcha (Ù†Ø³ØªØ®Ø¯Ù… render=explicit Ù„Ø§Ù„ØªÙ‚Ø§Ø· widgetId Ù„ÙƒÙ„ Ù†Ù…ÙˆØ°Ø¬) -->
  <script src="https://js.hcaptcha.com/1/api.js?onload=onHCaptchaLoad&render=explicit" async defer></script>
</head>
<body>
<header>
  <div class="title-card">
    <h1>Ù…Ù†ØµØ© Ø§Ù„Ø´ÙƒØ§ÙŠØ§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h1>
    <div class="muted">
      ØªÙÙ†Ø´Ø± Ø§Ù„Ø´ÙƒØ§ÙŠØ§Øª Ø¨Ù…Ù„Ø®Øµ ÙÙ‚Ø·ØŒ ÙˆØ§Ù„ÙˆØ«Ø§Ø¦Ù‚ Ø§Ù„Ù…ÙˆÙ‚Ø¹Ø© ØªÙØ­ÙØ¸ Ù„Ø¯Ù‰ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆÙ„Ø§ ØªÙÙØªØ­ Ù„Ù„Ø¹Ø§Ù…Ø©.
      Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ØªÙØ¹Ø±Ø¶ ÙƒØ§Ù…Ù„Ø© Ù…Ø§ Ù„Ù… ØªØªØ¶Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø§Ø³Ø©.
    </div>
  </div>
  <nav class="nav-actions">
    <a id="toComplaints" class="nav-btn">â• Ø´ÙƒÙˆÙ‰</a>
    <a id="toReports" class="nav-btn">ğŸ“‘ ØªÙ‚Ø±ÙŠØ±</a>
    <a href="about.html" class="nav-btn">â„¹ï¸ Ø­ÙˆÙ„ Ø§Ù„Ù…Ù†ØµØ©</a>
    <a id="toDonations" class="nav-btn">âš–ï¸ Ø§Ù„ØªØ¨Ø±Ø¹Ø§Øª</a>
  </nav>
</header>

  <!-- Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
  <section class="tabs">
    <button class="tab-btn active" data-tab="complaintTab">Ù†Ù…ÙˆØ°Ø¬ Ø´ÙƒÙˆÙ‰</button>
    <button class="tab-btn" data-tab="reportTab">Ù†Ù…ÙˆØ°Ø¬ ØªÙ‚Ø±ÙŠØ±</button>
    <button class="tab-btn" data-tab="complaintsListTab">Ø§Ù„Ø´ÙƒØ§ÙŠØ§Øª Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø©</button>
    <button class="tab-btn" data-tab="reportsListTab">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø©</button>
    <button class="tab-btn" data-tab="statusTab">ØªØªØ¨Ø¹ Ø§Ù„Ø­Ø§Ù„Ø©</button>
    <button class="tab-btn" data-tab="donationsTab">ğŸ’° Ø§Ù„ØªØ¨Ø±Ø¹Ø§Øª</button>
  </section>

  <!-- ØªØªØ¨Ø¹ Ø§Ù„Ø­Ø§Ù„Ø© -->
  <section id="statusTab" class="card" style="display:none">
    <div class="section-title"><h2>ØªØªØ¨Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ø´ÙƒÙˆÙ‰/Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h2></div>
    <p class="muted">Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù ÙƒÙ…Ø§ Ø¸Ù‡Ø± Ù„Ùƒ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ù…Ø«Ø§Ù„: 123).</p>
    <div class="row">
      <input id="trackNumber" type="number" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù (Ø¨Ø¯ÙˆÙ† #)" />
      <button id="trackBtn" class="btn">Ø§Ø³ØªØ¹Ù„Ø§Ù…</button>
    </div>
    <div id="trackResult" style="margin-top:12px"></div>
  </section>

  <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø´ÙƒÙˆÙ‰ -->
  <section id="complaintTab" class="card">
    <div class="section-title"><h2>Ø¥ÙŠØ¯Ø§Ø¹ Ø´ÙƒÙˆÙ‰ (Ù…ÙˆÙ‚Ù‘Ø¹Ø©)</h2></div>
    <p class="muted">Ù„Ù† ØªÙÙ‚Ø¨Ù„ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø¨Ø¯ÙˆÙ† Ø±ÙØ¹ ÙˆØ«ÙŠÙ‚Ø©/ØµÙˆØ±Ø© Ù…ÙˆÙ‚Ø¹Ø© Ø¨Ø®Ø· Ø§Ù„ÙŠØ¯. Ø³ÙŠØ¸Ù‡Ø± Ù„Ù„Ø¹Ù…ÙˆÙ… <b>Ù…Ù„Ø®Øµ Ø§Ù„Ø´ÙƒÙˆÙ‰ ÙÙ‚Ø·</b> ÙˆØ§Ø³Ù…Ùƒ Ø­Ø³Ø¨ Ø±ØºØ¨ØªÙƒ.</p>
    <form id="complaintForm">
      <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
      <input name="fullName" required placeholder="Ø§Ù„Ø§Ø³Ù… ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©" />
      <label>Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø§Ø³Ù… Ù„Ù„Ø¹Ù…ÙˆÙ…ØŸ</label>
      <select name="showName" required>
        <option value="yes">Ù†Ø¹Ù…ØŒ Ø§Ø¹Ø±Ø¶ Ø§Ø³Ù…ÙŠ</option>
        <option value="no">Ù„Ø§ØŒ Ø£Ø®ÙÙ Ø§Ø³Ù…ÙŠ</option>
      </select>
      <label>ØªØ§Ø±ÙŠØ® ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø´ÙƒÙˆÙ‰</label>
      <input type="date" name="submittedDate" required />
      <label>Ù†ÙˆØ¹ Ø§Ù„Ø´ÙƒÙˆÙ‰</label>
      <select name="category" required>
        <option value="">â€” Ø§Ø®ØªØ± â€”</option>
        <option>Ø´Ø¹Ø§Ø¦Ø±</option><option>Ø¶ÙˆØ¶Ø§Ø¡</option><option>Ù†Ø¸Ø§ÙØ©</option><option>ÙØ³Ø§Ø¯ Ø¥Ø¯Ø§Ø±ÙŠ</option><option>Ø£Ø®Ø±Ù‰</option>
      </select>
      <label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©/Ø§Ù„Ù…ÙƒØ§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <input name="place" placeholder="Ù…Ø«Ø§Ù„: ÙØ§Ø³ - Ù…Ø³Ø¬Ø¯ ..." />
      <label>Ù…Ù„Ø®Øµ Ø§Ù„Ø´ÙƒÙˆÙ‰ (Ø³ÙŠÙÙ†Ø´Ø± Ù„Ù„Ø¹Ù…ÙˆÙ…ØŒ 120â€“400 Ø­Ø±Ù)</label>
      <textarea name="summary" rows="4" minlength="120" maxlength="400" required placeholder="Ø§ÙƒØªØ¨ Ø®Ù„Ø§ØµØ© Ø¯Ù‚ÙŠÙ‚Ø© ÙˆÙ…ÙˆØ¶ÙˆØ¹ÙŠØ© Ø¯ÙˆÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø´Ø®ØµÙŠØ© Ù„Ø£Ø·Ø±Ø§Ù Ø£Ø®Ø±Ù‰."></textarea>
      <div class="hint">Ø§Ù„Ù†Øµ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„ Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹Ø© Ø§Ù„ØªÙŠ Ø³ØªØ±ÙØ¹Ù‡Ø§.</div>
      <label>ÙˆØ«ÙŠÙ‚Ø©/ØµÙˆØ±Ø© Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹Ø© (PDF/PNG/JPG â‰¤ 10MB) â€” Ø¥Ù„Ø²Ø§Ù…ÙŠ</label>
      <input type="file" name="proofFile" accept=".pdf,image/png,image/jpeg" required />

      <!-- hCaptcha Ù„Ù„Ø´ÙƒÙˆÙ‰ -->
      <div id="captcha-complaint" style="margin-top:10px"></div>

      <div class="row">
        <button type="submit" class="btn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø´ÙƒÙˆÙ‰</button>
        <span id="complaintStatus" class="muted"></span>
      </div>
    </form>
  </section>

  <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªÙ‚Ø±ÙŠØ± -->
  <section id="reportTab" class="card" style="display:none">
    <div class="section-title"><h2>Ø¥Ø¶Ø§ÙØ© ØªÙ‚Ø±ÙŠØ± Ø±ØµØ¯</h2></div>
    <p class="muted">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ØªÙØ¹Ø±Ø¶ ÙƒØ§Ù…Ù„Ø© Ù„Ù„Ø¹Ù…ÙˆÙ… (Ù…Ø¹ Ù…Ø±Ø§Ø¹Ø§Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©). Ø§Ø°ÙƒØ± Ø§Ù„ÙˆÙ‚Ø§Ø¦Ø¹ Ø¨Ø¯Ù‚Ø© ÙˆØ²Ù…Ù†Ù‡Ø§ ÙˆÙ…ÙƒØ§Ù†Ù‡Ø§.</p>
    <form id="reportForm">
      <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù„Ù†ÙŠ)</label>
      <input name="fullName" placeholder="ÙŠÙ…ÙƒÙ† ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºÙ‹Ø§ Ø¥Ù† Ø±ØºØ¨Øª" />
      <label>ØªØ§Ø±ÙŠØ®/ÙˆÙ‚Øª Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©</label>
      <input type="datetime-local" name="eventDateTime" required />
      <label>Ø§Ù„Ù…ÙƒØ§Ù†</label>
      <input name="place" required placeholder="Ù…Ø³Ø¬Ø¯/Ø­ÙŠ/Ø¹Ù†ÙˆØ§Ù†" />
      <label>Ø§Ù„ØªØµÙ†ÙŠÙ</label>
      <select name="category" required>
        <option value="">â€” Ø§Ø®ØªØ± â€”</option>
        <option>Ø´Ø¹Ø§Ø¦Ø±</option><option>Ø¶ÙˆØ¶Ø§Ø¡</option><option>Ù†Ø¸Ø§ÙØ©</option><option>ÙØ³Ø§Ø¯ Ø¥Ø¯Ø§Ø±ÙŠ</option><option>Ø£Ø®Ø±Ù‰</option>
      </select>
      <label>Ù†Øµ Ø§Ù„ØªÙ‚Ø±ÙŠØ± (â‰¥ 120 Ø­Ø±ÙÙ‹Ø§)</label>
      <textarea name="body" rows="6" minlength="120" required placeholder="ÙˆØµÙ Ù…ÙˆØ¶ÙˆØ¹ÙŠ Ù„Ù„ÙˆØ§Ù‚Ø¹Ø©: Ù…Ø§Ø°Ø§ Ø­Ø¯Ø«ØŸ Ù…ØªÙ‰ØŸ Ø£ÙŠÙ†ØŸ"></textarea>
      <label>Ø±ÙˆØ§Ø¨Ø· Ø£Ø¯Ù„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <input name="evidenceUrl" type="url" placeholder="https://..." />

      <!-- hCaptcha Ù„Ù„ØªÙ‚Ø±ÙŠØ± -->
      <div id="captcha-report" style="margin-top:10px"></div>

      <div class="row">
        <button type="submit" class="btn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        <span id="reportStatus" class="muted"></span>
      </div>
    </form>
  </section>

  <!-- Ø§Ù„Ø´ÙƒØ§ÙŠØ§Øª Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø© -->
  <section id="complaintsListTab" class="card" style="display:none">
    <div class="section-title"><h2>Ø§Ù„Ø´ÙƒØ§ÙŠØ§Øª Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø© (Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©)</h2></div>
    <div id="complaintsList" class="grid" aria-live="polite"></div>
  </section>

  <!-- Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø© -->
  <section id="reportsListTab" class="card" style="display:none">
    <div class="section-title"><h2>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø© (Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©)</h2></div>
    <div id="reportsList" class="grid" aria-live="polite"></div>
  </section>

  <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªØ¨Ø±Ø¹Ø§Øª -->
  <section id="donationsTab" class="card" style="display:none">
    <div class="section-title"><h2>Ø§Ù„ØªØ¨Ø±Ø¹Ø§Øª ÙˆØ¯Ø¹Ù… Ø§Ù„Ù…Ù†ØµØ©</h2></div>

    <p class="muted">
      Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†ØµØ© Ù…Ø´Ø±ÙˆØ¹ Ù…Ø¯Ù†ÙŠ ØºÙŠØ± Ø±Ø¨Ø­ÙŠ. Ø§Ù„ØªØ¨Ø±Ø¹Ø§Øª ØªÙØ³ØªØ®Ø¯Ù… Ù„ØªØºØ·ÙŠØ© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ØªÙ‚Ù†ÙŠØ© (Ø§Ù„Ø§Ø³ØªØ¶Ø§ÙØ©ØŒ Ø§Ù„ØªØ®Ø²ÙŠÙ†ØŒ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù†Ø·Ø§Ù‚Ø§Øª)
      ÙˆÙ„Ø¯Ø¹Ù… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ù…Ø³ØªÙ…Ø± ÙˆØ¥Ø¶Ø§ÙØ© Ø®ØµØ§Ø¦Øµ Ø¬Ø¯ÙŠØ¯Ø©. Ù…Ø³Ø§Ù‡Ù…ØªÙƒ ØªØ³Ø§Ø¹Ø¯ ÙÙŠ Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ù…Ù†ØµØ© Ø´ØºØ§Ù„Ø©ØŒ Ø³Ø±ÙŠØ¹Ø©ØŒ ÙˆØ¢Ù…Ù†Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹.
    </p>

    <div class="card" style="margin-top:10px">
      <h3 style="margin:0 0 6px">Ø§Ù„ØªØ¨Ø±Ø¹ Ø¹Ø¨Ø± <b>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø¨Ù†Ùƒ</b></h3>
      <div class="row" style="align-items: center">
        <div class="badge">Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</div>
        <code id="bank-acc" style="user-select:all">9408915</code>
        <button class="pill" onclick="copyText('#bank-acc')">Ù†Ø³Ø®</button>
      </div>
      <div class="row" style="margin-top:8px;align-items: center">
        <div class="badge">Ø§Ø³Ù… ØµØ§Ø­Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨</div>
        <code id="bank-name" style="user-select:all">yassine iboun</code>
        <button class="pill" onclick="copyText('#bank-name')">Ù†Ø³Ø®</button>
      </div>
    </div>

    <div class="card" style="margin-top:10px">
      <h3 style="margin:0 0 6px">Ø§Ù„ØªØ¨Ø±Ø¹ Ø¹Ø¨Ø± <b>USDT (BEP20)</b></h3>
      <div class="row" style="align-items: center">
        <div class="badge">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</div>
        <code id="usdt-bep20" style="word-break:break-all;user-select:all">
          0xE55C8cbBEb6c40b7ea18e0D418495267b487978e
        </code>
        <button class="pill" onclick="copyText('#usdt-bep20')">Ù†Ø³Ø®</button>
      </div>
      <p class="muted" style="margin-top:8px">
        ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø´Ø¨ÙƒØ© <b>BEP20</b> Ø¹Ù†Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„.
      </p>
    </div>

    <div class="hint">
      Ø³Ù†Ù†Ø´Ø± Ù„Ø§Ø­Ù‚Ù‹Ø§ Ù…Ù„Ø®ØµØ§Øª Ø´ÙØ§ÙÙŠØ© Ø¯ÙˆØ±ÙŠØ© ØªÙˆØ¶Ø­ Ø£ÙˆØ¬Ù‡ Ø§Ù„ØµØ±Ù (Ø§Ø³ØªØ¶Ø§ÙØ©/ØªØ·ÙˆÙŠØ±) Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø«Ù‚Ø© Ø§Ù„Ø¹Ø§Ù…Ø©.
      Ø´ÙƒØ±Ù‹Ø§ Ù„Ø¯Ø¹Ù…Ùƒ! ğŸ’™
    </div>
  </section>

  <div class="sep"></div>
  <footer class="muted">
    <p>ØªÙ†Ø¨ÙŠÙ‡: Ù„Ø§ ØªÙØ¹Ø±Ø¶ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚/Ø§Ù„ØªÙˆÙ‚ÙŠØ¹Ø§Øª Ø¹Ù„Ù†Ù‹Ø§. ØªÙØ­ÙØ¸ Ù„Ø¯Ù‰ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙÙ‚Ø· ÙƒØ¥Ø«Ø¨Ø§Øª.</p>
  </footer>

<!-- ØªÙŠÙ„Ø¬Ø±Ø§Ù… -->
<a href="https://t.me/chikayalive" target="_blank" class="telegram-fab" title="ØªØ§Ø¨Ø¹Ù†Ø§ Ø¹Ù„Ù‰ ØªÙŠÙ„Ø¬Ø±Ø§Ù…" aria-label="Ù‚Ù†Ø§Ø© ØªÙŠÙ„Ø¬Ø±Ø§Ù…">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240" width="28" height="28" fill="#fff" aria-hidden="true" focusable="false">
    <path d="M120 0C53.7 0 0 53.7 0 120s53.7 120 120 120 120-53.7 120-120S186.3 0 120 0zm58.3 81.9l-24.3 114.8c-1.8 8.3-6.7 10.4-13.5 6.5l-37.4-27.6-18 17.3c-2 2-3.6 3.6-7.3 3.6l2.6-37.7 68.6-61.9c3-2.6-.6-4.1-4.6-1.5l-84.8 53.5-36.5-11.4c-7.9-2.5-8.1-7.9 1.7-11.7l142.5-55.1c6.6-2.4 12.4 1.6 10.3 11.3z"/>
  </svg>
</a>

<script type="module">
/* === Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ === */
const REPO_OWNER = "Yassinehmd67";
const REPO_NAME  = "civic-complaints";

/* Ø¯ÙˆÙ…ÙŠÙ† Netlify (Ø¹Ù†Ø¯ Ø§Ù„ØªØµÙØ­ Ù…Ù† GitHub Pages) */
const NETLIFY_SITE = "https://delicate-maamoul-683849.netlify.app";

/* Ù‚Ø§Ø¹Ø¯Ø© ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø³ÙŠØ±ÙØ±: Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© */
const FN_BASE = location.hostname.endsWith(".netlify.app")
  ? "/.netlify/functions"
  : `${NETLIFY_SITE}/.netlify/functions`;

/* Supabase (Ø¹Ù…ÙˆÙ…ÙŠ) */
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const SUPABASE_URL  = "https://ymeaeffhygpkzkychdjn.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InltZWFlZmZoeWdwa3preWNoZGpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwOTY0MzgsImV4cCI6MjA3MjY3MjQzOH0.N1Bfhu3bdAfberMBe1aK2xXVxr0xK42hlTlo7mM4uWE";
const SUPABASE_BUCKET = "proofs";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

/* Ù…ÙØ§ØªÙŠØ­ hCaptcha (ÙˆØ§Ø¬Ù‡Ø© ÙÙ‚Ø·) */
const HCAPTCHA_SITE_KEY = "8f262b7a-face-428c-a24c-91c438fa76d4";

/* ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ hCaptcha */
let capComplaintId = null;
let capReportId = null;

/* hCaptcha onload callback (Ù…Ù† Ø®Ù„Ø§Ù„ Ø¨Ø§Ø±Ø§Ù…ØªØ± onload) */
window.onHCaptchaLoad = function onHCaptchaLoad(){
  try {
    if (document.getElementById("captcha-complaint")) {
      capComplaintId = hcaptcha.render("captcha-complaint", { sitekey: HCAPTCHA_SITE_KEY });
    }
    if (document.getElementById("captcha-report")) {
      capReportId = hcaptcha.render("captcha-report", { sitekey: HCAPTCHA_SITE_KEY });
    }
  } catch(e) {
    console.warn("hCaptcha render failed:", e);
  }
};

/* ØªØ¨ÙˆÙŠØ¨Ø§Øª */
const tabs = document.querySelectorAll(".tab-btn");
tabs.forEach(btn=>btn.onclick=()=>{
  tabs.forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  ["complaintTab","reportTab","complaintsListTab","reportsListTab","statusTab","donationsTab"].forEach(id=>{
    document.getElementById(id).style.display = (btn.dataset.tab===id) ? "" : "none";
  });
  if(btn.dataset.tab==="complaintsListTab") renderComplaints();
  if(btn.dataset.tab==="reportsListTab") renderReports();
});
document.getElementById("toComplaints").onclick = ()=>document.querySelector('.tab-btn[data-tab="complaintTab"]').click();
document.getElementById("toReports").onclick   = ()=>document.querySelector('.tab-btn[data-tab="reportTab"]').click();
const toDon = document.getElementById("toDonations");
if(toDon){ toDon.onclick = ()=>document.querySelector('.tab-btn[data-tab="donationsTab"]').click(); }

/* Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© */
function labelValue(labels, prefix){
  const l = (labels || []).find(x => {
    const n = (x.name || x).toString();
    return n.startsWith(prefix);
  });
  if (!l) return "";
  const n = (l.name || l).toString();
  const parts = n.split(":");
  return parts.length > 1 ? parts[1].trim() : "";
}
function summaryFromBody(body=""){
  const line = body.split("\n").find(l=>l.startsWith("**Ù…Ù„Ø®Øµ**:")) || "";
  return line.replace("**Ù…Ù„Ø®Øµ**:","").trim();
}
function statusLabel(labels){
  const has = n => (labels||[]).some(l=>(l.name||"")===n);
  if(has("approved")) return "âœ… Ù…Ù‚Ø¨ÙˆÙ„/Ù…Ù†Ø´ÙˆØ±";
  if(has("rejected")) return "âŒ Ù…Ø±ÙÙˆØ¶";
  if(has("needs-more-info")) return "â„¹ï¸ Ø¨Ø­Ø§Ø¬Ø© Ù„ØªÙˆØ¶ÙŠØ­";
  if(has("under-review")) return "ğŸ” Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©";
  if(has("pending")) return "âŒ› Ù‚ÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…";
  return "â€” ØºÙŠØ± Ù…Ø­Ø¯Ø¯ â€”";
}
function escapeHtml(s=''){
  return s.replace(/[&<>"'`=\/]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[c]));
}
function copyText(selector){
  const el = document.querySelector(selector);
  if(!el) return;
  const txt = (el.textContent || el.value || "").trim();
  if(!txt) return;
  navigator.clipboard.writeText(txt).then(()=>{ alert("ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…"); }, ()=>{
    const ta = document.createElement("textarea");
    ta.value = txt; document.body.appendChild(ta); ta.select();
    try { document.execCommand("copy"); alert("ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…"); }
    catch { alert("ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ù†Ø³Ø®ØŒ Ø§Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠÙ‹Ø§."); }
    finally { document.body.removeChild(ta); }
  });
}

/* Ø¨Ø·Ø§Ù‚Ø© Ø¹Ù†ØµØ± */
function cardFor(issue, type){
  const labels = issue.labels || [];
  const topic = labelValue(labels, "topic:");
  const city  = labelValue(labels, "city:");
  const created = new Date(issue.created_at);
  const url = issue.html_url;
  const number = issue.number;
  const commentsCount = issue.comments || 0;
  const likes = (issue.reactions && typeof issue.reactions["+1"]==="number") ? issue.reactions["+1"] : (issue.reactions?.total_count || 0);

  const body = (issue.body||"");
  const summaryText = summaryFromBody(body);
  const excerpt = body.replace(/\r?\n/g," ").slice(0,240) + (body.length>240?"â€¦":"");
  const content = (type==="complaint") ? (summaryText || "â€”") : excerpt;
  const badgeType = (type==="complaint") ? "Ø´ÙƒÙˆÙ‰ (Ù…Ù„Ø®Øµ)" : "ØªÙ‚Ø±ÙŠØ±";

  const liked = localStorage.getItem(`liked:${number}`) === "1";
  const likeBtnAttr = liked ? 'disabled aria-disabled="true"' : '';

  return `
  <article class="card" id="card-${number}">
    <div class="row">
      <span class="badge">${badgeType}</span>
      ${topic?`<span class="badge">Ù…ÙˆØ¶ÙˆØ¹: ${escapeHtml(topic)}</span>`:""}
      ${city?`<span class="badge">Ø§Ù„Ù…ÙƒØ§Ù†: ${escapeHtml(city)}</span>`:""}
      <span class="badge">#${number}</span>
    </div>
    <h3 style="margin:6px 0 0"><a href="${url}" target="_blank" rel="noopener">${escapeHtml(issue.title||"Ù…Ù„Ù")}</a></h3>
    <div class="muted">${created.toLocaleDateString()} â€¢ ØªØ¹Ù„ÙŠÙ‚Ø§Øª: <span id="c-${number}">${commentsCount}</span> â€¢ Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª: <span id="l-${number}">${likes}</span></div>
    <p>${escapeHtml(content)}</p>

    <div class="actions">
      <button class="pill" id="like-${number}" ${likeBtnAttr} onclick="upvote(${number})">${liked ? "ØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ ØµÙˆØªÙƒ" : "Ø¶Ù…Ù‘ ØµÙˆØªÙŠ (Ø¥Ø¹Ø¬Ø§Ø¨)"}</button>
      <a class="pill" href="${url}" target="_blank" rel="noopener">ÙØªØ­ Ø¹Ù„Ù‰ GitHub</a>
      <a class="pill" href="${url}#new_comment_field" target="_blank" rel="noopener">ÙØªØ­ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</a>
    </div>

    <details style="margin-top:8px">
      <summary>Ø£Ø¶Ù Ø´Ù‡Ø§Ø¯Ø©/ØªØ¹Ù„ÙŠÙ‚</summary>
      <form class="comment-form" data-issue="${number}" style="margin-top:8px">
        <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
        <input name="fullName" required />
        <label>Ø§Ù„ØªØ¹Ù„ÙŠÙ‚/Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</label>
        <textarea name="comment" rows="4" required minlength="40"></textarea>

        <!-- hCaptcha Ù„Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª (ÙŠØªÙ… render Ø¹Ù†Ø¯ Ø§Ù„Ø±Ø¨Ø·) -->
        <div class="comment-captcha" style="margin:8px 0"></div>

        <div class="row">
          <button type="submit" class="btn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚</button>
          <span class="muted status"></span>
        </div>
      </form>
    </details>
  </article>`;
}

/* ÙƒØ§Ø´ Ø¨Ø³ÙŠØ· (60 Ø«Ø§Ù†ÙŠØ©) */
function cacheGet(key, maxAgeMs=60000){
  try{
    const raw = sessionStorage.getItem(key);
    if(!raw) return null;
    const obj = JSON.parse(raw);
    if(Date.now() - obj.t > maxAgeMs) return null;
    return obj.v;
  }catch{ return null }
}
function cacheSet(key, val){
  try{ sessionStorage.setItem(key, JSON.stringify({ t: Date.now(), v: val })); }catch{}
}

/* Ø¬Ù„Ø¨ approved Ø¨Ø°ÙƒØ§Ø¡ */
async function fetchApprovedSmart(filters = {}) {
  const onNetlify = location.hostname.endsWith(".netlify.app");
  const cacheKey = "approved:" + JSON.stringify(filters) + ":" + (onNetlify?"netlify":"ghpages");
  const cached = cacheGet(cacheKey);
  if(cached) return cached;

  let items = [];

  if (onNetlify) {
    // ÙˆÙƒÙŠÙ„ Netlify
    const params = new URLSearchParams();
    if (filters.type)  params.set("type",  filters.type);
    if (filters.topic) params.set("topic", filters.topic);
    if (filters.city)  params.set("city",  filters.city);

    const url = `${FN_BASE}/listApproved` + (params.toString() ? ("?" + params.toString()) : "");
    const r = await fetch(url, { headers: { "Accept": "application/json" } });
    if (!r.ok) throw new Error("Proxy error");
    const data = await r.json(); // { ok, count, items }
    items = data.items || [];
  } else {
    // GitHub Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† GitHub Pages
    let page = 1;
    while (true) {
      const url = new URL(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues`);
      url.searchParams.set("state", "open");
      url.searchParams.set("labels", "approved");
      url.searchParams.set("per_page", "100");
      url.searchParams.set("page", String(page));

      const r = await fetch(url.toString(), { headers: { "Accept": "application/vnd.github+json" } });
      if (!r.ok) break;
      const batch = (await r.json()).filter(i => !i.pull_request);
      items.push(...batch);
      if (batch.length < 100) break;
      page++;
    }
    const getVal = (labels, pfx) => {
      const L = (labels||[]).find(l => (l.name||"").startsWith(pfx));
      return L ? (L.name.split(":")[1]||"").trim() : "";
      };
    items = items.filter(i => {
      const type  = getVal(i.labels, "type:");
      const topic = getVal(i.labels, "topic:");
      const city  = getVal(i.labels, "city:");
      if (filters.type  && type  !== filters.type)  return false;
      if (filters.topic && topic !== filters.topic) return false;
      if (filters.city  && city  !== filters.city)  return false;
      return true;
    });
  }

  cacheSet(cacheKey, items);
  return items;
}

/* Ø¹Ø±Ø¶ Ø§Ù„Ø´ÙƒØ§ÙŠØ§Øª */
async function renderComplaints(){
  const list = document.getElementById("complaintsList");
  list.innerHTML = "<p class='muted'>â€¦ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„</p>";
  try{
    const items = await fetchApprovedSmart({ type: "complaint" });
    list.innerHTML = items.map(it=>cardFor(it,"complaint")).join("") || "<p class='muted'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´ÙƒØ§ÙŠØ§Øª Ù…Ù†Ø´ÙˆØ±Ø© Ø¨Ø¹Ø¯.</p>";
    bindCommentForms(list);
  }catch(e){
    list.innerHTML = "<p class='muted'>ØªØ¹Ø°Ù‘Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„.</p>";
    console.error(e);
  }
}

/* Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± */
async function renderReports(){
  const list = document.getElementById("reportsList");
  list.innerHTML = "<p class='muted'>â€¦ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„</p>";
  try{
    const items = await fetchApprovedSmart({ type: "report" });
    list.innerHTML = items.map(it=>cardFor(it,"report")).join("") || "<p class='muted'>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ù†Ø´ÙˆØ±Ø© Ø¨Ø¹Ø¯.</p>";
    bindCommentForms(list);
  }catch(e){
    list.innerHTML = "<p class='muted'>ØªØ¹Ø°Ù‘Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„.</p>";
    console.error(e);
  }
}

/* Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª + hCaptcha */
function bindCommentForms(scope=document){
  scope.querySelectorAll(".comment-form").forEach(form=>{
    // Render hCaptcha Ø¯Ø§Ø®Ù„ ÙƒÙ„ Ù†Ù…ÙˆØ°Ø¬ ØªØ¹Ù„ÙŠÙ‚ (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)
    const capHost = form.querySelector(".comment-captcha");
    if (capHost && !capHost.dataset.widgetId && window.hcaptcha && HCAPTCHA_SITE_KEY) {
      try {
        const widgetId = hcaptcha.render(capHost, { sitekey: HCAPTCHA_SITE_KEY });
        capHost.dataset.widgetId = String(widgetId);
      } catch {}
    }

    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const fd = new FormData(form);
      const payload = {
        issueNumber: Number(form.dataset.issue),
        fullName: fd.get("fullName"),
        comment: fd.get("comment")
      };

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† hCaptcha Ù„Ù„ØªØ¹Ù„ÙŠÙ‚
      const capDiv = form.querySelector(".comment-captcha");
      const widgetId = capDiv && capDiv.dataset.widgetId ? Number(capDiv.dataset.widgetId) : null;
      const token = (window.hcaptcha && widgetId != null) ? hcaptcha.getResponse(widgetId) : null;
      if (!token) {
        const s = form.querySelector(".status");
        s.textContent = "ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ hCaptcha Ø£ÙˆÙ„Ù‹Ø§.";
        return;
      }
      payload.hcaptchaToken = token;

      const status = form.querySelector(".status");
      status.textContent = "Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„â€¦";
      try{
        const r = await fetch(`${FN_BASE}/submitComment`, {
          method:"POST", headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });
        status.textContent = r.ok ? "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©." : "ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.";
        if(r.ok){
          form.reset();
          // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· hCaptcha Ù„Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
          if (widgetId != null && window.hcaptcha) hcaptcha.reset(widgetId);
          const c = document.getElementById(`c-${payload.issueNumber}`);
          if(c) c.textContent = String(Number(c.textContent||"0")+1);
        }
      }catch{ status.textContent = "ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„." }
    });
  });
}

/* Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨ Ù…Ø¹ Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¹Ø¨Ø± localStorage */
window.upvote = async function upvote(issueNumber){
  const key = `liked:${issueNumber}`;
  const btn = document.getElementById(`like-${issueNumber}`);
  if (localStorage.getItem(key) === "1") {
    btn.textContent = "ØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ ØµÙˆØªÙƒ";
    btn.disabled = true;
    btn.setAttribute("aria-disabled", "true");
    alert("ØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ ØµÙˆØªÙƒ âœ…");
    return;
  }
  btn.disabled = true;
  try{
    const r = await fetch(`${FN_BASE}/upvoteIssue`, {
      method:"POST", headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ issueNumber })
    });
    if(r.ok){
      const l = document.getElementById(`l-${issueNumber}`);
      if(l) l.textContent = String(Number(l.textContent||"0")+1);
      localStorage.setItem(key, "1");
      btn.textContent = "ØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ ØµÙˆØªÙƒ";
      btn.setAttribute("aria-disabled", "true");
      alert("ØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ ØµÙˆØªÙƒ âœ…");
    }else{
      btn.disabled = false;
      alert("ØªØ¹Ø°Ù‘Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨ Ø§Ù„Ø¢Ù†.");
    }
  }catch(e){
    btn.disabled = false;
    alert("ØªØ¹Ø°Ù‘Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨.");
  }
}

/* --- Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø´ÙƒÙˆÙ‰: ØªØ°ÙƒØ±Ø© Ø±ÙØ¹ (Ù…Ø¹ hCaptcha) + Ø±ÙØ¹ Ù…Ø¨Ø§Ø´Ø± + Ø¥Ø±Ø³Ø§Ù„ proofPath ÙÙ‚Ø· --- */
document.getElementById("complaintForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const form = e.target;
  const fd = new FormData(form);

  const status = document.getElementById("complaintStatus");
  status.textContent = "Ø¬Ø§Ø±Ù Ø§Ù„Ø±ÙØ¹ ÙˆØ§Ù„ØªØ­Ù‚Ù‚â€¦";

  const file = fd.get("proofFile");
  if(!file || file.size===0){ status.textContent = "Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…ÙˆÙ‚Ù‘Ø¹ Ù…Ø·Ù„ÙˆØ¨."; return; }
  if(file.size > 10*1024*1024){ status.textContent = "Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù Ø£ÙƒØ¨Ø± Ù…Ù† 10MB."; return; }

  // hCaptcha token Ù„Ù„Ø´ÙƒÙˆÙ‰
  const token = (window.hcaptcha && capComplaintId!=null) ? hcaptcha.getResponse(capComplaintId) : null;
  if (!token) { status.textContent = "ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ hCaptcha Ø£ÙˆÙ„Ù‹Ø§."; return; }

  let proofPath = "";
  try{
    // 1) ØªØ°ÙƒØ±Ø© Ø±ÙØ¹ (ØªÙ…Ø±ÙŠØ± Ù†ÙˆØ¹ØŒ Ø­Ø¬Ù…ØŒ ÙˆØ±Ù…Ø² hCaptcha)
    const tkRes = await fetch(`${FN_BASE}/getUploadTicket`, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ mime: file.type || "application/pdf", size: file.size, hcaptchaToken: token })
    });
    if(!tkRes.ok){
      const t = await tkRes.text();
      throw new Error("ÙØ´Ù„ ØªØ­Ø¶ÙŠØ± ØªØ°ÙƒØ±Ø© Ø§Ù„Ø±ÙØ¹: " + t);
    }
    const { path, token: signedToken } = await tkRes.json();

    // 2) Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ÙÙ‚Ø·
    const up = await supabase.storage.from(SUPABASE_BUCKET)
      .uploadToSignedUrl(path, signedToken, file, {
        upsert:false,
        contentType: file.type || "application/octet-stream"
      });
    if(up.error) throw up.error;

    proofPath = path;
  }catch(err){
    console.error("Direct upload error:", err);
    status.textContent = "ØªØ¹Ø°Ù‘Ø± Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù. ØªØ­Ù‚Ù‘Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.";
    return;
  }

  // 3) Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´ÙƒÙˆÙ‰ (Ù†Ø±Ø³Ù„ Ø§Ù„Ù…Ø³Ø§Ø± ÙÙ‚Ø·) + hCaptcha
  const payload = {
    fullName: fd.get("fullName"),
    showName: fd.get("showName"),
    submittedDate: fd.get("submittedDate"),
    category: fd.get("category"),
    place: fd.get("place"),
    summary: fd.get("summary"),
    proofPath,
    hcaptchaToken: token
  };

  try{
    const r = await fetch(`${FN_BASE}/submitComplaint`, {
      method:"POST", headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });

    if(!r.ok){
      const t = await r.text();
      status.textContent = "ØªØ¹Ø°Ù‘Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø´ÙƒÙˆÙ‰: " + t;
      return;
    }

    const data = await r.json(); // { number, html_url }
    status.innerHTML = `ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©. <b>Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù: ${data.number}</b> â€” <a href="${data.html_url}" target="_blank" rel="noopener">ÙØªØ­ Ø¹Ù„Ù‰ GitHub</a>`;
    form.reset();

    // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Captcha
    if (window.hcaptcha && capComplaintId!=null) hcaptcha.reset(capComplaintId);

    // Ø§ÙØªØ­ ØªØ¨ÙˆÙŠØ¨ ØªØªØ¨Ø¹ Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ¬Ù‡Ù‘Ø² Ø§Ù„Ø±Ù‚Ù…
    document.querySelector('.tab-btn[data-tab="statusTab"]').click();
    const tn = document.getElementById("trackNumber");
    if(tn){ tn.value = data.number; }
  }catch(err){
    status.textContent = "ØªØ¹Ø°Ù‘Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø´ÙƒÙˆÙ‰. ØªØ­Ù‚Ù‘Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ.";
  }
});

/* Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± (+ hCaptcha) */
document.getElementById("reportForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const form = e.target;
  const fd = new FormData(form);

  const status = document.getElementById("reportStatus");
  status.textContent = "Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„â€¦";

  // hCaptcha token Ù„Ù„ØªÙ‚Ø±ÙŠØ±
  const token = (window.hcaptcha && capReportId!=null) ? hcaptcha.getResponse(capReportId) : null;
  if (!token) { status.textContent = "ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ hCaptcha Ø£ÙˆÙ„Ù‹Ø§."; return; }

  const payload = {
    fullName: fd.get("fullName"),
    eventDateTime: fd.get("eventDateTime"),
    place: fd.get("place"),
    category: fd.get("category"),
    body: fd.get("body"),
    evidenceUrl: fd.get("evidenceUrl"),
    hcaptchaToken: token
  };
  try{
    const r = await fetch(`${FN_BASE}/submitReport`, {
      method:"POST", headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });

    if(!r.ok){
      status.textContent = "ØªØ¹Ø°Ù‘Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.";
      return;
    }

    const data = await r.json(); // { number, html_url }
    status.innerHTML = `ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©. <b>Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù: ${data.number}</b> â€” <a href="${data.html_url}" target="_blank" rel="noopener">ÙØªØ­ Ø¹Ù„Ù‰ GitHub</a>`;
    form.reset();

    // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Captcha
    if (window.hcaptcha && capReportId!=null) hcaptcha.reset(capReportId);

    // Ø§ÙØªØ­ ØªØ¨ÙˆÙŠØ¨ ØªØªØ¨Ø¹ Ø§Ù„Ø­Ø§Ù„Ø©
    document.querySelector('.tab-btn[data-tab="statusTab"]').click();
    const tn = document.getElementById("trackNumber");
    if(tn){ tn.value = data.number; }
  }catch{
    status.textContent = "ØªØ¹Ø°Ù‘Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±. ØªØ­Ù‚Ù‘Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ.";
  }
});

/* ØªØªØ¨Ø¹ Ø§Ù„Ø­Ø§Ù„Ø© */
document.getElementById("trackBtn").addEventListener("click", async () => {
  const num = Number(document.getElementById("trackNumber").value);
  const box = document.getElementById("trackResult");
  if (!num) { box.innerHTML = "<p class='muted'>Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ù‹Ø§ ØµØ­ÙŠØ­Ù‹Ø§.</p>"; return; }
  box.innerHTML = "<p class='muted'>â€¦ Ø¬Ø§Ø±Ù Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…</p>";
  try {
    const r = await fetch(`${FN_BASE}/getStatus?number=${num}`);
    if (!r.ok) { box.innerHTML = "<p class='muted'>ØªØ¹Ø°Ù‘Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø­Ø§Ù„Ø©.</p>"; return; }
    const d = await r.json();

    // Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆÙÙ‚ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø© Ù…Ù† state.json (Ø§ÙØªØ±Ø§Ø¶ÙŠ: Africa/Casablanca)
    const _tz = window.__appTZ || "Africa/Casablanca";
    const createdStr = new Intl.DateTimeFormat("ar-MA", {
      timeZone: _tz, year: "numeric", month: "2-digit", day: "2-digit"
    }).format(new Date(d.created_at));

    box.innerHTML = `
      <div class="card">
        <div class="row">
          <span class="badge">#${d.number}</span>
          <span class="badge">${d.type==="complaint"?"Ø´ÙƒÙˆÙ‰":"ØªÙ‚Ø±ÙŠØ±"}</span>
          ${d.topic?`<span class="badge">Ù…ÙˆØ¶ÙˆØ¹: ${escapeHtml(d.topic)}</span>`:""}
          ${d.city?`<span class="badge">Ø§Ù„Ù…ÙƒØ§Ù†: ${escapeHtml(d.city)}</span>`:""}
        </div>
        <h3 style="margin:6px 0 0">${escapeHtml(d.title)}</h3>
        <div class="muted">${createdStr} â€¢ Ø§Ù„Ø­Ø§Ù„Ø©: <b>${statusLabel(d.labels)}</b></div>
        <p>${escapeHtml(d.display)}</p>
        <div class="row">
          <a class="pill" href="${d.html_url}" target="_blank" rel="noopener">ÙØªØ­ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ GitHub</a>
        </div>
      </div>`;
  } catch {
    box.innerHTML = "<p class='muted'>Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù….</p>";
  }
});

/* ref= */
(function init(){
  const params = new URLSearchParams(location.search);
  const ref = params.get("ref");
  if(ref){
    document.querySelector('.tab-btn[data-tab="complaintsListTab"]').click();
    window.open(`https://github.com/${REPO_OWNER}/${REPO_NAME}/issues/${ref}#new_comment_field`,"_blank");
  }
})();
</script>

<script>
(async function prefillUX(){
  // 1) Ù‚Ø±Ø§Ø¡Ø© state.json Ø¥Ù† ÙˆÙØ¬Ø¯
  let city = "", tz = "Africa/Casablanca";
  try {
    const r = await fetch("./state.json", { cache: "no-store" });
    if (r.ok) {
      const s = await r.json();
      city = s?.geolocation?.data?.city || "";
      tz   = s?.geolocation?.data?.timezone || tz;
    }
  } catch {} 
  finally {
    // Ø®Ø²Ù‘Ù† Ø§Ù„Ù€TZ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø¹Ø§Ù„Ù…ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø³Ù…
    window.__appTZ = tz;
  }

  // 2) Ù…Ù„Ø¡ Ø­Ù‚Ù„ Ø§Ù„Ù…ÙƒØ§Ù† Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ (Ø§Ù„Ø´ÙƒÙˆÙ‰/Ø§Ù„ØªÙ‚Ø±ÙŠØ±) Ø¥Ù† ÙƒØ§Ù† ÙØ§Ø±ØºÙ‹Ø§
  const placeInputs = [
    document.querySelector('#complaintForm input[name="place"]'),
    document.querySelector('#reportForm    input[name="place"]')
  ].filter(Boolean);
  if (city) {
    placeInputs.forEach(el => { if (el && !el.value) el.value = city; });
  }

  // 3) Ø¶Ø¨Ø· ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´ÙƒÙˆÙ‰ Ù„Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆÙÙ‚ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©
  try {
    const dt = new Date();
    const parts = new Intl.DateTimeFormat('en-CA', {
      timeZone: tz, year: 'numeric', month: '2-digit', day: '2-digit'
    }).formatToParts(dt);
    const yyyy = parts.find(p => p.type === 'year')?.value || String(dt.getFullYear());
    const mm   = parts.find(p => p.type === 'month')?.value || String(dt.getMonth() + 1).padStart(2, '0');
    const dd   = parts.find(p => p.type === 'day')?.value || String(dt.getDate()).padStart(2, '0');
    const today = `${yyyy}-${mm}-${dd}`;
    const dateEl = document.querySelector('#complaintForm input[name="submittedDate"]');
    if (dateEl && !dateEl.value) dateEl.value = today;
  } catch {}

  // 4) Ø¥Ø¸Ù‡Ø§Ø± Ù…Ù„Ø§Ø­Ø¸Ø© ØµØºÙŠØ±Ø© Ø¨Ø§Ù„ØªÙˆÙ‚ÙŠØª Ø§Ù„Ù…Ø­Ù„ÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  try {
    const note = document.createElement('div');
    note.className = 'muted';
    note.style.margin = '6px 0';
    note.textContent = `Ø§Ù„ØªÙˆÙ‚ÙŠØª Ø§Ù„Ù…Ø­Ù„ÙŠ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯: ${tz}${city ? ` â€¢ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©: ${city}` : ''}`;
    document.querySelector('header')?.appendChild(note);
  } catch {}

  // 5) ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ Ù„ÙƒÙ„ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡Ø§Øª fetchApprovedSmart Ø¯ÙˆÙ† ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù‚ÙŠØ© Ø§Ù„ÙƒÙˆØ¯
  if (typeof window.fetchApprovedSmart === 'function' && city) {
    const _orig = window.fetchApprovedSmart;
    window.fetchApprovedSmart = (filters = {}) => _orig({ city, ...filters });
  }
})();
</script>
</body> 
</html>
