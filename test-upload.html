<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>اختبار رفع Supabase</title>
<style>
  body{font-family:system-ui,Arial;max-width:700px;margin:24px auto;padding:0 12px;line-height:1.8}
  .card{border:1px solid #e6e6e6;border-radius:12px;padding:16px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input[type=file]{padding:8px;border:1px solid #ddd;border-radius:8px}
  button{padding:10px 14px;border:0;border-radius:10px;background:#111;color:#fff;cursor:pointer}
  .muted{color:#666}
  textarea{width:100%;height:120px}
</style>
</head>
<body>
  <h1>اختبار رفع Supabase (Base64 → Netlify Function)</h1>
  <div class="card">
    <div class="row">
      <input type="file" id="fileInput" accept=".pdf,image/png,image/jpeg" />
      <button id="sendBtn">رفع</button>
    </div>
    <p class="muted" id="status">جاهز للاختبار…</p>
    <label>استجابة الخادم:</label>
    <textarea id="respBox" readonly></textarea>
  </div>

<script>
// عدّل هذا إلى رابط موقعك على نتلايفي:
const FN_BASE = "https://delicate-maamoul-683849.netlify.app/.netlify/functions";

async function fileToBase64(file){
  return new Promise((resolve, reject)=>{
    const reader = new FileReader();
    reader.onload = () => {
      // reader.result مثل: "data:application/pdf;base64,JVBERi0xLjc..."
      const res = reader.result;
      const commaIdx = res.indexOf(',');
      resolve(res.slice(commaIdx + 1)); // خذ الجزء الـ base64 فقط
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

document.getElementById('sendBtn').addEventListener('click', async ()=>{
  const f = document.getElementById('fileInput').files[0];
  const status = document.getElementById('status');
  const respBox = document.getElementById('respBox');

  if(!f){ status.textContent = "اختر ملفًا أولًا."; return; }
  status.textContent = "جارٍ تحويل الملف إلى Base64…";

  try{
    const b64 = await fileToBase64(f);
    status.textContent = "جارٍ الرفع إلى الوظيفة…";

    const r = await fetch(`${FN_BASE}/uploadProof`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        fileName: f.name,
        fileContent: b64
      })
    });

    const txt = await r.text(); // قد تكون JSON أو نص
    respBox.value = txt;

    if(r.ok){
      status.textContent = "تم الرفع بنجاح ✅";
    }else{
      status.textContent = "تعذّر الرفع ❌ — افحص التفاصيل في المربّع.";
    }
  }catch(err){
    status.textContent = "حدث خطأ أثناء التحويل/الرفع.";
    respBox.value = err?.message || String(err);
  }
});
</script>
</body>
</html>
