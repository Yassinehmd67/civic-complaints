import { createClient } from "@supabase/supabase-js";

const { SUPABASE_URL, SUPABASE_SERVICE_ROLE, SUPABASE_BUCKET } = process.env;

export async function handler() {
  try {
    if (!SUPABASE_URL || !SUPABASE_SERVICE_ROLE || !SUPABASE_BUCKET) {
      return { statusCode: 500, body: "❌ Env vars ناقصة" };
    }

    const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE);

    const bytes = Buffer.from("Hello from Netlify testUpload!");
    const objectName = `proofs/test-${Date.now()}.txt`;

    const { error } = await supabase
      .storage
      .from(SUPABASE_BUCKET)
      .upload(objectName, bytes, { contentType: "text/plain" });

    if (error) {
      return { statusCode: 500, body: `❌ Upload error: ${error.message}` };
    }

    return { statusCode: 200, body: `✅ رفع ناجح: ${objectName}` };
  } catch (e) {
    return { statusCode: 500, body: `❌ Exception: ${e.message}` };
  }
}
