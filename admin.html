<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>لوحة الإدارة</title>
  <style>
    body{font-family:system-ui,Arial;max-width:900px;margin:24px auto;padding:0 12px;line-height:1.8;background:#fff;color:#111}
    h1{margin:0 0 12px}
    .card{border:1px solid #e6e6e6;border-radius:14px;padding:16px;margin:14px 0;background:#fff}
    label{display:block;margin:8px 0 4px}
    input,select,button{padding:10px;border:1px solid #ccc;border-radius:10px;font-size:1rem}
    input,select{width:100%}
    button{background:#111;color:#fff;cursor:pointer;border-radius:10px}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .btn.outline,
    button.outline{background:#fff;color:#111;border:1px solid #ccc}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .muted{color:#666}
    .success{color:#0a8f2f}
    .error{color:#b00020}
    .badge{display:inline-block;background:#f3f3f3;border:1px solid #e6e6e6;border-radius:999px;padding:2px 10px;font-size:.85em;margin-inline:4px 0}
    .tiny{font-size:.9em}
  </style>
</head>
<body>
  <h1>لوحة الإدارة</h1>
  <p class="muted tiny">
    لتغيير حالة الشكايات/التقارير وإدارة التعليقات المعلّقة. التحقق يتم على الخادم عبر <b>Bcrypt</b> باستخدام
    <code>ADMIN_HASH</code> المخزن في متغيرات بيئة Netlify.
  </p>

  <!-- إدارة الحالات -->
  <div class="card" id="adminCard">
    <label for="issueNumber">رقم الملف (Issue Number)</label>
    <input id="issueNumber" type="number" placeholder="مثال: 123" inputmode="numeric" />

    <div class="row">
      <button id="checkBtn">استعلام الحالة الحالية</button>
      <a id="openGhBtn" class="badge" href="#" target="_blank" rel="noopener" style="display:none">فتح الملف على GitHub</a>
      <span id="checkStatus" class="muted"></span>
    </div>

    <div id="currentBox" class="card" style="display:none;margin-top:10px">
      <div class="row" id="currentBadges"></div>
      <h3 id="currentTitle" style="margin:6px 0 0"></h3>
      <div id="currentMeta" class="muted"></div>
      <p id="currentExcerpt" style="margin:8px 0 0"></p>
    </div>

    <hr style="border:none;height:1px;background:#eee;margin:14px 0">

    <label for="newStatus">الحالة الجديدة</label>
    <select id="newStatus">
      <option value="approved">مقبول/منشور</option>
      <option value="rejected">مرفوض</option>
      <option value="pending">قيد الاستلام</option>
      <option value="under-review">قيد المراجعة</option>
      <option value="needs-more-info">بحاجة لتوضيح</option>
    </select>

    <label for="adminPassword">كلمة السر</label>
    <input id="adminPassword" type="password" placeholder="••••••••" autocomplete="current-password" />

    <div class="row">
      <button id="applyBtn">تطبيق الحالة</button>
      <span id="status" class="muted"></span>
    </div>
  </div>

  <!-- إدارة التعليقات المعلّقة -->
  <div class="card" id="commentsModeration" style="margin-top:22px">
    <h2 style="margin:0 0 10px">التعليقات المعلّقة</h2>
    <p class="muted tiny">لا يمكن القبول/الرفض إلا بعد إدخال كلمة السر في الحقل أعلاه.</p>

    <div class="row">
      <button id="refreshCommentsBtn" class="btn">تحديث القائمة</button>
      <span id="cmStatus" class="muted"></span>
    </div>

    <div id="pendingList" style="margin-top:12px">
      <p class="muted">— لا يوجد عناصر —</p>
    </div>
  </div>

<!-- اختيار تلقائي لقاعدة الدوال -->
<script>
  const IS_LOCAL = location.hostname === "localhost" || location.hostname === "127.0.0.1" || /^\d+\.\d+\.\d+\.\d+$/.test(location.hostname);
  const FN_BASE = IS_LOCAL
    ? `${location.protocol}//${location.host}/.netlify/functions`
    : "https://delicate-maamoul-683849.netlify.app/.netlify/functions";
  window.FN_BASE = FN_BASE;
</script>

<script>
/* ====== مساعدات عامة ====== */
function prettyStatus(labels){
  const names = (labels||[]).map(l=>l.name||l);
  const has = n => names.includes(n);
  if(has("approved")) return "✅ مقبول/منشور";
  if(has("rejected")) return "❌ مرفوض";
  if(has("needs-more-info")) return "ℹ️ بحاجة لتوضيح";
  if(has("under-review")) return "🔎 قيد المراجعة";
  if(has("pending")) return "⌛ قيد الاستلام";
  return "— غير محدد —";
}
function safeJson(text){
  try{ return JSON.parse(text) } catch{ return null }
}

/* ====== عناصر DOM (الحالات) ====== */
const issueNumberEl = document.getElementById("issueNumber");
const checkBtn = document.getElementById("checkBtn");
const openGhBtn = document.getElementById("openGhBtn");
const checkStatus = document.getElementById("checkStatus");
const currentBox = document.getElementById("currentBox");
const currentBadges = document.getElementById("currentBadges");
const currentTitle = document.getElementById("currentTitle");
const currentMeta = document.getElementById("currentMeta");
const currentExcerpt = document.getElementById("currentExcerpt");

const newStatusEl = document.getElementById("newStatus");
const adminPasswordEl = document.getElementById("adminPassword");
const applyBtn = document.getElementById("applyBtn");
const statusEl = document.getElementById("status");

/* تحسينات UX: Enter = استعلام */
issueNumberEl.addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){ checkBtn.click() }
});

/* زر: استعلام حالة ملف */
checkBtn.addEventListener("click", async ()=>{
  const number = Number(issueNumberEl.value);
  if(!number){
    checkStatus.textContent = "❗ أدخل رقم ملف صالح.";
    checkStatus.className = "error";
    currentBox.style.display = "none";
    openGhBtn.style.display = "none";
    return;
  }
  checkStatus.textContent = "⏳ جارٍ الاستعلام…";
  checkStatus.className = "muted";
  currentBox.style.display = "none";
  openGhBtn.style.display = "none";
  checkBtn.disabled = true;

  try{
    const r = await fetch(`${FN_BASE}/getStatus?number=${number}`, { cache: "no-store" });
    const txt = await r.text();
    if(!r.ok){
      checkStatus.textContent = "❌ فشل: " + (txt || r.status);
      checkStatus.className = "error";
      return;
    }
    const d = safeJson(txt);
    if(!d){
      checkStatus.textContent = "⚠️ استجابة غير متوقعة من الخادم.";
      checkStatus.className = "error";
      return;
    }

    const badges = [];
    badges.push(`<span class="badge">#${d.number}</span>`);
    badges.push(`<span class="badge">${d.type==="complaint"?"شكوى":"تقرير"}</span>`);
    if(d.topic) badges.push(`<span class="badge">موضوع: ${d.topic}</span>`);
    if(d.city)  badges.push(`<span class="badge">المكان: ${d.city}</span>`);
    currentBadges.innerHTML = badges.join("");

    currentTitle.textContent = d.title || "—";
    currentMeta.innerHTML = `${new Date(d.created_at).toLocaleDateString()} • الحالة: <b>${prettyStatus(d.labels)}</b>`;
    currentExcerpt.textContent = (d.display||"").slice(0,280);

    if(d.html_url){
      openGhBtn.href = d.html_url;
      openGhBtn.style.display = "inline-block";
    }

    currentBox.style.display = "";
    checkStatus.textContent = "✅ تم الاستعلام.";
    checkStatus.className = "success";
  }catch(e){
    checkStatus.textContent = "⚠️ خطأ في الشبكة.";
    checkStatus.className = "error";
  }finally{
    checkBtn.disabled = false;
  }
});

/* زر: تطبيق الحالة */
applyBtn.addEventListener("click", async ()=>{
  const number = Number(issueNumberEl.value);
  const state  = newStatusEl.value;
  const pass   = adminPasswordEl.value;

  if(!number || !state || !pass){
    statusEl.textContent = "❗ أكمل الحقول.";
    statusEl.className = "error";
    return;
  }

  statusEl.textContent = "⏳ جارٍ التنفيذ…";
  statusEl.className = "muted";
  applyBtn.disabled = true;

  try{
    const r = await fetch(`${FN_BASE}/adminSetStatus`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ number, state, password: pass })
    });
    const txt = await r.text();
    if(!r.ok){
      statusEl.textContent = "❌ فشل: " + (txt || r.status);
      statusEl.className = "error";
      return;
    }

    statusEl.textContent = "✅ تم التحديث بنجاح.";
    statusEl.className = "success";
    adminPasswordEl.value = "";

    checkBtn.click();
  }catch(e){
    statusEl.textContent = "⚠️ خطأ في الشبكة.";
    statusEl.className = "error";
  }finally{
    applyBtn.disabled = false;
  }
});

/* Deep-link: دعم ?issue=123 */
(function init(){
  const params = new URLSearchParams(location.search);
  const n = Number(params.get("issue"));
  if(n){
    issueNumberEl.value = String(n);
    checkBtn.click();
  }
  issueNumberEl.focus();
})();

/* ====== إدارة التعليقات المعلّقة ====== */
const refreshCommentsBtn = document.getElementById("refreshCommentsBtn");
const pendingList = document.getElementById("pendingList");
const cmStatus = document.getElementById("cmStatus");

function renderRow(item){
  const box = document.createElement("div");
  box.className = "card";
  box.style.marginTop = "10px";
  const created = new Date(item.created_at).toLocaleString();

  box.innerHTML = `
    <div class="row">
      <span class="badge">Issue #${item.issue_number}</span>
      <span class="badge">${created}</span>
    </div>
    <div style="margin-top:6px"><b>${item.full_name}</b></div>
    <div class="muted" style="white-space:pre-wrap;margin-top:6px">${item.comment}</div>
    <div class="row" style="margin-top:10px">
      <button data-action="approve" data-id="${item.id}">قبول</button>
      <button data-action="reject" data-id="${item.id}" class="outline">رفض</button>
    </div>
  `;
  box.querySelectorAll("button[data-action]").forEach(btn=>{
    btn.addEventListener("click", ()=> moderate(btn.dataset.action, btn.dataset.id, btn));
  });
  return box;
}

async function loadPending(){
  cmStatus.textContent = "⏳ جارٍ التحميل…";
  pendingList.innerHTML = "";
  try{
    const r = await fetch(`${FN_BASE}/listPendingComments`, { cache: "no-store" });
    const d = await r.json();
    if(!r.ok || !d.ok){
      cmStatus.textContent = "❌ فشل القراءة.";
      return;
    }
    if(!d.items || d.items.length === 0){
      pendingList.innerHTML = `<p class="muted">— لا يوجد عناصر —</p>`;
    }else{
      d.items.forEach(it => pendingList.appendChild(renderRow(it)));
    }
    cmStatus.textContent = "✅ تم التحديث.";
  }catch{
    cmStatus.textContent = "⚠️ خطأ شبكة.";
  }
}

async function moderate(action, id, buttonEl){
  const pwd = adminPasswordEl.value.trim();
  if(!pwd){
    alert("أدخل كلمة السر أولًا.");
    return;
  }
  buttonEl.disabled = true;
  cmStatus.textContent = "⏳ جارٍ التنفيذ…";
  try{
    const r = await fetch(`${FN_BASE}/moderateComment`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ action, id, password: pwd })
    });
    const txt = await r.text();
    if(!r.ok){
      cmStatus.textContent = "❌ فشل: " + (txt || r.status);
      return;
    }
    const d = (()=>{ try{return JSON.parse(txt)}catch{return null} })();
    if(!d || !d.ok){
      cmStatus.textContent = "⚠️ استجابة غير متوقعة.";
      return;
    }
    cmStatus.textContent = (action === "approve") ? "✅ تم القبول ونُشر التعليق." : "🗑️ تم الرفض والحذف.";
    await loadPending();
  }catch{
    cmStatus.textContent = "⚠️ خطأ شبكة.";
  }finally{
    buttonEl.disabled = false;
  }
}

refreshCommentsBtn.addEventListener("click", loadPending);
loadPending();
</script>
</body>
</html>
