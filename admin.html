<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</title>
  <style>
    body{font-family:system-ui,Arial;max-width:820px;margin:24px auto;padding:0 12px;line-height:1.8;background:#fff;color:#111}
    h1{margin:0 0 12px}
    .card{border:1px solid #e6e6e6;border-radius:14px;padding:16px;margin:14px 0;background:#fff}
    label{display:block;margin:8px 0 4px}
    input,select,button{padding:10px;border:1px solid #ccc;border-radius:10px;font-size:1rem}
    input,select{width:100%}
    button{background:#111;color:#fff;cursor:pointer;border-radius:10px}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .muted{color:#666}
    .success{color:#0a8f2f}
    .error{color:#b00020}
    .badge{display:inline-block;background:#f3f3f3;border:1px solid #e6e6e6;border-radius:999px;padding:2px 10px;font-size:.85em;margin-inline:4px 0}
    .tiny{font-size:.9em}
  </style>
</head>
<body>
  <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>
  <p class="muted tiny">
    Ù„ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø´ÙƒØ§ÙŠØ§Øª/Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±. Ø§Ù„ØªØ­Ù‚Ù‚ ÙŠØªÙ… Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù… Ø¹Ø¨Ø± <b>Bcrypt</b> Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù…
    <code>ADMIN_HASH</code> Ø§Ù„Ù…Ø®Ø²Ù† ÙÙŠ Ù…ØªØºÙŠØ±Ø§Øª Ø¨ÙŠØ¦Ø© Netlify.
  </p>

  <div class="card" id="adminCard">
    <label for="issueNumber">Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù (Issue Number)</label>
    <input id="issueNumber" type="number" placeholder="Ù…Ø«Ø§Ù„: 123" inputmode="numeric" />

    <div class="row">
      <button id="checkBtn">Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</button>
      <a id="openGhBtn" class="badge" href="#" target="_blank" rel="noopener" style="display:none">ÙØªØ­ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ GitHub</a>
      <span id="checkStatus" class="muted"></span>
    </div>

    <div id="currentBox" class="card" style="display:none;margin-top:10px">
      <div class="row" id="currentBadges"></div>
      <h3 id="currentTitle" style="margin:6px 0 0"></h3>
      <div id="currentMeta" class="muted"></div>
      <p id="currentExcerpt" style="margin:8px 0 0"></p>

      <!-- Ø£Ø²Ø±Ø§Ø± Ø¥Ø¯Ø§Ø±ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ© -->
      <div class="row" style="margin-top:8px">
        <button id="proofBtn" title="Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø±ÙÙ‚ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</button>
        <span id="proofStatus" class="muted tiny"></span>
      </div>
    </div>

    <hr style="border:none;height:1px;background:#eee;margin:14px 0">

    <label for="newStatus">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
    <select id="newStatus">
      <option value="approved">Ù…Ù‚Ø¨ÙˆÙ„/Ù…Ù†Ø´ÙˆØ±</option>
      <option value="rejected">Ù…Ø±ÙÙˆØ¶</option>
      <option value="pending">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</option>
      <option value="under-review">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
      <option value="needs-more-info">Ø¨Ø­Ø§Ø¬Ø© Ù„ØªÙˆØ¶ÙŠØ­</option>
    </select>

    <label for="adminPassword">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
    <input id="adminPassword" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" />

    <div class="row">
      <button id="applyBtn">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„Ø©</button>
      <span id="status" class="muted"></span>
    </div>
  </div>

<script>
/* === Ø§Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø§Ø± ÙˆØ¸Ø§Ø¦Ù Ù†Ø³Ø¨ÙŠ Ù„ÙŠØ¹Ù…Ù„ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙˆØ¹Ù„Ù‰ Netlify === */
const FN_BASE = "/.netlify/functions";

/* Ù…Ø³Ø§Ø¹Ø¯Ø§Øª */
function prettyStatus(labels){
  const names = (labels||[]).map(l=>l.name||l);
  const has = n => names.includes(n);
  if(has("approved")) return "âœ… Ù…Ù‚Ø¨ÙˆÙ„/Ù…Ù†Ø´ÙˆØ±";
  if(has("rejected")) return "âŒ Ù…Ø±ÙÙˆØ¶";
  if(has("needs-more-info")) return "â„¹ï¸ Ø¨Ø­Ø§Ø¬Ø© Ù„ØªÙˆØ¶ÙŠØ­";
  if(has("under-review")) return "ğŸ” Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©";
  if(has("pending")) return "âŒ› Ù‚ÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…";
  return "â€” ØºÙŠØ± Ù…Ø­Ø¯Ø¯ â€”";
}
function safeJson(text){
  try{ return JSON.parse(text) } catch{ return null }
}

/* Ø¹Ù†Ø§ØµØ± DOM */
const issueNumberEl = document.getElementById("issueNumber");
const checkBtn = document.getElementById("checkBtn");
const openGhBtn = document.getElementById("openGhBtn");
const checkStatus = document.getElementById("checkStatus");
const currentBox = document.getElementById("currentBox");
const currentBadges = document.getElementById("currentBadges");
const currentTitle = document.getElementById("currentTitle");
const currentMeta = document.getElementById("currentMeta");
const currentExcerpt = document.getElementById("currentExcerpt");

const newStatusEl = document.getElementById("newStatus");
const adminPasswordEl = document.getElementById("adminPassword");
const applyBtn = document.getElementById("applyBtn");
const statusEl = document.getElementById("status");

const proofBtn = document.getElementById("proofBtn");
const proofStatus = document.getElementById("proofStatus");

/* ØªØ­Ø³ÙŠÙ†Ø§Øª UX: Enter = Ø§Ø³ØªØ¹Ù„Ø§Ù… */
issueNumberEl.addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){ checkBtn.click() }
});

/* Ø²Ø±: Ø§Ø³ØªØ¹Ù„Ø§Ù… */
checkBtn.addEventListener("click", async ()=>{
  const number = Number(issueNumberEl.value);
  if(!number){
    checkStatus.textContent = "â— Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù…Ù„Ù ØµØ§Ù„Ø­.";
    checkStatus.className = "error";
    currentBox.style.display = "none";
    openGhBtn.style.display = "none";
    return;
  }
  checkStatus.textContent = "â³ Ø¬Ø§Ø±Ù Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…â€¦";
  checkStatus.className = "muted";
  currentBox.style.display = "none";
  openGhBtn.style.display = "none";
  checkBtn.disabled = true;

  try{
    const r = await fetch(`${FN_BASE}/getStatus?number=${number}`, { cache: "no-store" });
    const txt = await r.text();
    if(!r.ok){
      checkStatus.textContent = "âŒ ÙØ´Ù„: " + (txt || r.status);
      checkStatus.className = "error";
      return;
    }
    const d = safeJson(txt);
    if(!d){
      checkStatus.textContent = "âš ï¸ Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù….";
      checkStatus.className = "error";
      return;
    }

    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    const badges = [];
    badges.push(`<span class="badge">#${d.number}</span>`);
    badges.push(`<span class="badge">${d.type==="complaint"?"Ø´ÙƒÙˆÙ‰":"ØªÙ‚Ø±ÙŠØ±"}</span>`);
    if(d.topic) badges.push(`<span class="badge">Ù…ÙˆØ¶ÙˆØ¹: ${d.topic}</span>`);
    if(d.city)  badges.push(`<span class="badge">Ø§Ù„Ù…ÙƒØ§Ù†: ${d.city}</span>`);
    currentBadges.innerHTML = badges.join("");

    currentTitle.textContent = d.title || "â€”";
    currentMeta.innerHTML = `${new Date(d.created_at).toLocaleDateString()} â€¢ Ø§Ù„Ø­Ø§Ù„Ø©: <b>${prettyStatus(d.labels)}</b>`;
    currentExcerpt.textContent = (d.display||"").slice(0,280);

    if(d.html_url){
      openGhBtn.href = d.html_url;
      openGhBtn.style.display = "inline-block";
    }

    currentBox.style.display = "";
    checkStatus.textContent = "âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù….";
    checkStatus.className = "success";
  }catch(e){
    checkStatus.textContent = "âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©.";
    checkStatus.className = "error";
  }finally{
    checkBtn.disabled = false;
  }
});

/* Ø²Ø±: ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„Ø© */
applyBtn.addEventListener("click", async ()=>{
  const number = Number(issueNumberEl.value);
  const state  = newStatusEl.value;
  const pass   = adminPasswordEl.value;

  if(!number || !state || !pass){
    statusEl.textContent = "â— Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„.";
    statusEl.className = "error";
    return;
  }

  statusEl.textContent = "â³ Ø¬Ø§Ø±Ù Ø§Ù„ØªÙ†ÙÙŠØ°â€¦";
  statusEl.className = "muted";
  applyBtn.disabled = true;

  try{
    const r = await fetch(`${FN_BASE}/adminSetStatus`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ number, state, password: pass })
    });
    const txt = await r.text();
    if(!r.ok){
      statusEl.textContent = "âŒ ÙØ´Ù„: " + (txt || r.status);
      statusEl.className = "error";
      return;
    }

    statusEl.textContent = "âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­.";
    statusEl.className = "success";
    // ÙŠÙ…ÙƒÙ† Ù…Ø³Ø­ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­ Ø£Ùˆ Ø¥Ø¨Ù‚Ø§Ø¡Ù‡Ø§ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø²Ø± Ø§Ù„Ù…Ø±ÙÙ‚
    // adminPasswordEl.value = "";

    // ØªØ­Ø¯ÙŠØ« ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø©
    checkBtn.click();
  }catch(e){
    statusEl.textContent = "âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©.";
    statusEl.className = "error";
  }finally{
    applyBtn.disabled = false;
  }
});

/* Ø²Ø±: Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ (ÙŠØ³ØªØ¯Ø¹ÙŠ getProofLink) */
proofBtn.addEventListener("click", async ()=>{
  const number = Number(issueNumberEl.value);
  const pass = adminPasswordEl.value; // Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… X-Admin-Key ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± Ø¨Ø¯Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±
  if(!number){
    proofStatus.textContent = "Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù…Ù„Ù ØµØ§Ù„Ø­ Ø£ÙˆÙ„Ù‹Ø§.";
    proofStatus.className = "error tiny";
    return;
  }
  proofBtn.disabled = true;
  proofStatus.textContent = "Ø¬Ø§Ø±Ù ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø·â€¦";
  proofStatus.className = "muted tiny";
  try{
    const r = await fetch(`${FN_BASE}/getProofLink`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        // Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙØªØ§Ø­ Ø«Ø§Ø¨Øª Ø¨Ø¯Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):
        // "X-Admin-Key": "Ø¶Ø¹_Ø§Ù„Ù‚ÙŠÙ…Ø©_Ø§Ù„Ø³Ø±ÙŠØ©_Ø¥Ù†_Ø§Ø³ØªØ®Ø¯Ù…Øª_ADMIN_KEY"
      },
      body: JSON.stringify({ issueNumber: number, password: pass })
    });
    const t = await r.text();
    if(!r.ok){ throw new Error(t || r.statusText); }
    const d = safeJson(t) || {};
    if(d.signedUrl){
      proofStatus.textContent = "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø§Ø¨Ø·. ÙŠÙÙØªØ­ ÙÙŠ Ù„Ø³Ø§Ù† Ø¬Ø¯ÙŠØ¯.";
      proofStatus.className = "success tiny";
      window.open(d.signedUrl, "_blank", "noopener");
    }else{
      proofStatus.textContent = "ØªØ¹Ø°Ù‘Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø§Ø¨Ø·.";
      proofStatus.className = "error tiny";
    }
  }catch(e){
    proofStatus.textContent = "ØªØ¹Ø°Ù‘Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø§Ø¨Ø·: " + (e.message||e);
    proofStatus.className = "error tiny";
  }finally{
    proofBtn.disabled = false;
  }
});

/* Deep-link: Ø¯Ø¹Ù… ?issue=123 Ù„ÙØªØ­ Ø§Ù„Ù…Ù„Ù Ù…Ø¨Ø§Ø´Ø±Ø© */
(function init(){
  const params = new URLSearchParams(location.search);
  const n = Number(params.get("issue"));
  if(n){
    issueNumberEl.value = String(n);
    checkBtn.click();
  }
  issueNumberEl.focus();
})();
</script>
</body>
</html>
